<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO Grid & Weather Forecast Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0b0c0f;
            --bg-secondary: #0f1115;
            --bg-tertiary: #121826;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --accent: #60a5fa;
            --accent-hover: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #1c2330;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
        }

        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.06);
            z-index: 9999;
        }

        .topbar .bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #60a5fa, #22d3ee);
            transition: width 0.25s ease;
        }

        header {
            background: var(--bg-secondary);
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 3px;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .title {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(135deg, #60a5fa 0%, #22d3ee 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        input[type="text"] {
            padding: 10px 12px;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            width: 100px;
        }

        button {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        button:hover {
            border-color: #2a3548;
            background: #1a2332;
        }

        button.primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        button.primary:hover {
            background: var(--accent-hover);
        }

        .status-bar {
            padding: 10px 16px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .metric-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-time {
            font-size: 12px;
            color: var(--accent);
            margin-top: 4px;
        }

        .grid {
            display: grid;
            gap: 16px;
            padding: 16px 0;
        }

        .card {
            position: relative;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px 16px;
            box-shadow: 0 1px 0 rgba(255,255,255,0.03), 0 12px 30px rgba(0,0,0,0.35);
        }

        .card h3 {
            margin: 0 0 8px;
            font-size: 16px;
            font-weight: 500;
        }

        canvas {
            width: 100%;
            height: 330px;
            max-height: 420px;
            background: #0c0f14;
            border-radius: 12px;
        }

        .overlay {
            position: absolute;
            inset: 12px 16px 16px 16px;
            display: grid;
            place-items: center;
            background: rgba(10,12,16,0.55);
            backdrop-filter: blur(2px);
            border-radius: 12px;
        }

        .overlay[hidden] {
            display: none;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border-radius: 9999px;
            border: 3px solid rgba(255,255,255,0.25);
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
            margin: auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .msg {
            margin-top: 8px;
            color: #cbd5e1;
            font-size: 12px;
            text-align: center;
        }

        .renewable-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 16px 0;
        }

        .renewable-bar {
            flex: 1;
            height: 8px;
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
            border-radius: 4px;
            position: relative;
        }

        .renewable-marker {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
            transition: left 0.3s ease;
        }

        .alert-signup {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid var(--border);
        }

        .alert-signup h3 {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .alert-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert-form input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .error-msg {
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #fca5a5;
            margin: 10px 0;
            font-size: 14px;
        }

        .info-msg {
            padding: 10px;
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #93c5fd;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="topbar" aria-hidden="true">
        <div class="bar" id="progress-bar"></div>
    </div>

    <header>
        <div class="header-content">
            <h1 class="title">ISO Grid &amp; Weather Forecast Dashboard</h1>
            <div class="controls">
                <label>ZIP: <input type="text" id="zipCode" value="90210" maxlength="5" pattern="[0-9]{5}"></label>
                <button class="primary" id="updateBtn">Update</button>
                <button id="autoRefreshBtn">Auto-Refresh: ON</button>
                <button id="exportBtn">Export Report</button>
            </div>
        </div>
    </header>

    <div class="status-bar" id="statusBar">
        <span id="statusText">Ready</span> | Location: <span id="locationText">Beverly Hills, CA</span> | ISO: <span id="isoText">CISO</span> | Last Update: <span id="lastUpdate">Never</span>
    </div>

    <div class="container">
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Today's Peak Temperature</div>
                <div class="metric-value" id="todayPeakTemp">--°F</div>
                <div class="metric-time" id="todayPeakTime">at --:--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Tomorrow's Peak Temperature</div>
                <div class="metric-value" id="tomorrowPeakTemp">--°F</div>
                <div class="metric-time" id="tomorrowPeakTime">at --:--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Today's Grid Peak</div>
                <div class="metric-value" id="todayGridPeak">-- MW</div>
                <div class="metric-time" id="todayGridPeakTime">at --:--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Tomorrow's Grid Peak</div>
                <div class="metric-value" id="tomorrowGridPeak">-- MW</div>
                <div class="metric-time" id="tomorrowGridPeakTime">at --:--</div>
            </div>
        </div>

        <div class="renewable-indicator">
            <span>Grid Cleanliness:</span>
            <div class="renewable-bar">
                <div class="renewable-marker" id="renewableMarker" style="left: 50%;"></div>
            </div>
            <span id="renewablePercent">50% Renewable</span>
        </div>

        <div class="grid">
            <section class="card">
                <h3>30-Day Weather Forecast</h3>
                <div class="overlay" id="overlay-weather">
                    <div>
                        <div class="spinner" role="status"></div>
                        <div class="msg">Loading weather data...</div>
                    </div>
                </div>
                <canvas id="weatherChart"></canvas>
            </section>

            <section class="card">
                <h3>30-Day ISO Load Forecast</h3>
                <div class="overlay" id="overlay-iso">
                    <div>
                        <div class="spinner" role="status"></div>
                        <div class="msg">Loading ISO data...</div>
                    </div>
                </div>
                <canvas id="loadChart"></canvas>
            </section>

            <section class="card">
                <h3>Today's Hourly Generation Mix</h3>
                <div class="overlay" id="overlay-mix">
                    <div>
                        <div class="spinner" role="status"></div>
                        <div class="msg">Loading generation data...</div>
                    </div>
                </div>
                <canvas id="generationChart"></canvas>
            </section>

            <section class="card">
                <h3>10-Day Forecast Accuracy</h3>
                <div class="overlay" id="overlay-accuracy">
                    <div>
                        <div class="spinner" role="status"></div>
                        <div class="msg">Calculating accuracy...</div>
                    </div>
                </div>
                <canvas id="accuracyChart"></canvas>
            </section>
        </div>

        <div class="alert-signup">
            <h3>Sign up for Daily Peak Alerts</h3>
            <form class="alert-form" id="alertForm">
                <input type="email" placeholder="Email address" id="alertEmail">
                <input type="tel" placeholder="Phone number (SMS)" id="alertPhone">
                <button type="submit" class="primary">Subscribe to Alerts</button>
            </form>
            <small style="color: var(--text-secondary); margin-top: 10px; display: block;">
                Receive daily peak weather and ISO alerts from alerts@isoforecasts.com
            </small>
        </div>

        <div id="errorContainer"></div>
    </div>

    <script>
        // Configuration
        const EIA_API_KEY = 'DDtDBwdrxbGSSPNQBFP2JWvWDfSxTeVzg7qFWBfI';
        
        // State
        let autoRefreshInterval;
        let autoRefreshEnabled = true;
        let historicalData = [];
        let currentData = {
            iso: 'CISO',
            location: { lat: 34.0736, lon: -118.4004, city: 'Beverly Hills', state: 'CA' },
            zip: '90210'
        };

        // Chart instances
        let weatherChart, loadChart, generationChart, accuracyChart;

        // ISO Mapping
        const ISO_MAP = {
            'CALIFORNIA INDEPENDENT SYSTEM OPERATOR': 'CISO',
            'PJM INTERCONNECTION, LLC': 'PJM',
            'ISO NEW ENGLAND INC.': 'ISNE',
            'NEW YORK INDEPENDENT SYSTEM OPERATOR': 'NYIS',
            'MIDCONTINENT INDEPENDENT TRANSMISSION SYSTEM OPERATOR, INC.': 'MISO',
            'SOUTHWEST POWER POOL': 'SWPP',
            'ELECTRIC RELIABILITY COUNCIL OF TEXAS, INC.': 'ERCO'
        };

        // ZIP to location database (covering all US regions)
        const ZIP_DATABASE = {
            // Northeast
            '01': {lat: 42.3, lon: -72.6, city: 'Springfield', state: 'MA'},
            '02': {lat: 42.3601, lon: -71.0589, city: 'Boston', state: 'MA'},
            '03': {lat: 43.2, lon: -71.5, city: 'Manchester', state: 'NH'},
            '04': {lat: 43.8, lon: -69.8, city: 'Portland', state: 'ME'},
            '05': {lat: 44.2, lon: -72.6, city: 'White River Junction', state: 'VT'},
            '06': {lat: 41.7, lon: -72.7, city: 'Hartford', state: 'CT'},
            '07': {lat: 40.7, lon: -74.2, city: 'Newark', state: 'NJ'},
            '08': {lat: 40.3, lon: -74.5, city: 'Trenton', state: 'NJ'},
            '09': {lat: 40.3, lon: -74.5, city: 'Trenton', state: 'NJ'},
            '10': {lat: 40.7128, lon: -74.0060, city: 'New York', state: 'NY'},
            '11': {lat: 40.6782, lon: -73.9442, city: 'Brooklyn', state: 'NY'},
            '12': {lat: 42.6526, lon: -73.7562, city: 'Albany', state: 'NY'},
            '13': {lat: 43.1, lon: -76.1, city: 'Syracuse', state: 'NY'},
            '14': {lat: 42.8864, lon: -78.8784, city: 'Buffalo', state: 'NY'},
            // Mid-Atlantic
            '15': {lat: 40.4406, lon: -79.9959, city: 'Pittsburgh', state: 'PA'},
            '16': {lat: 40.4406, lon: -79.9959, city: 'Pittsburgh', state: 'PA'},
            '17': {lat: 40.2737, lon: -76.8844, city: 'Harrisburg', state: 'PA'},
            '18': {lat: 40.6259, lon: -75.3704, city: 'Allentown', state: 'PA'},
            '19': {lat: 39.9526, lon: -75.1652, city: 'Philadelphia', state: 'PA'},
            '20': {lat: 38.9072, lon: -77.0369, city: 'Washington', state: 'DC'},
            '21': {lat: 39.2904, lon: -76.6122, city: 'Baltimore', state: 'MD'},
            '22': {lat: 38.8048, lon: -77.0469, city: 'Arlington', state: 'VA'},
            '23': {lat: 37.5407, lon: -77.4360, city: 'Richmond', state: 'VA'},
            '24': {lat: 37.2707, lon: -79.9414, city: 'Roanoke', state: 'VA'},
            '25': {lat: 38.3498, lon: -81.6326, city: 'Charleston', state: 'WV'},
            '26': {lat: 39.6295, lon: -79.9559, city: 'Wheeling', state: 'WV'},
            // Southeast
            '27': {lat: 35.7796, lon: -78.6382, city: 'Raleigh', state: 'NC'},
            '28': {lat: 35.2271, lon: -80.8431, city: 'Charlotte', state: 'NC'},
            '29': {lat: 34.0007, lon: -81.0348, city: 'Columbia', state: 'SC'},
            '30': {lat: 33.7490, lon: -84.3880, city: 'Atlanta', state: 'GA'},
            '31': {lat: 32.0809, lon: -81.0912, city: 'Savannah', state: 'GA'},
            '32': {lat: 30.3322, lon: -81.6557, city: 'Jacksonville', state: 'FL'},
            '33': {lat: 25.7617, lon: -80.1918, city: 'Miami', state: 'FL'},
            '34': {lat: 26.7153, lon: -80.0534, city: 'West Palm Beach', state: 'FL'},
            '35': {lat: 33.5186, lon: -86.8104, city: 'Birmingham', state: 'AL'},
            '36': {lat: 32.3668, lon: -86.3000, city: 'Montgomery', state: 'AL'},
            '37': {lat: 36.1627, lon: -86.7816, city: 'Nashville', state: 'TN'},
            '38': {lat: 35.1495, lon: -90.0490, city: 'Memphis', state: 'TN'},
            '39': {lat: 32.2988, lon: -90.1848, city: 'Jackson', state: 'MS'},
            // Midwest
            '40': {lat: 38.2527, lon: -85.7585, city: 'Louisville', state: 'KY'},
            '41': {lat: 38.2527, lon: -85.7585, city: 'Louisville', state: 'KY'},
            '42': {lat: 38.0406, lon: -84.5037, city: 'Lexington', state: 'KY'},
            '43': {lat: 39.9612, lon: -82.9988, city: 'Columbus', state: 'OH'},
            '44': {lat: 41.4995, lon: -81.6954, city: 'Cleveland', state: 'OH'},
            '45': {lat: 39.0997, lon: -84.5133, city: 'Cincinnati', state: 'OH'},
            '46': {lat: 39.7684, lon: -86.1581, city: 'Indianapolis', state: 'IN'},
            '47': {lat: 38.9716, lon: -87.5711, city: 'Terre Haute', state: 'IN'},
            '48': {lat: 42.3314, lon: -83.0458, city: 'Detroit', state: 'MI'},
            '49': {lat: 42.9634, lon: -85.6681, city: 'Grand Rapids', state: 'MI'},
            '50': {lat: 41.5868, lon: -93.6250, city: 'Des Moines', state: 'IA'},
            '51': {lat: 42.5003, lon: -96.4003, city: 'Sioux City', state: 'IA'},
            '52': {lat: 42.0333, lon: -91.5931, city: 'Dubuque', state: 'IA'},
            '53': {lat: 43.0389, lon: -87.9065, city: 'Milwaukee', state: 'WI'},
            '54': {lat: 44.5192, lon: -88.0198, city: 'Green Bay', state: 'WI'},
            '55': {lat: 44.9778, lon: -93.2650, city: 'Minneapolis', state: 'MN'},
            '56': {lat: 44.1638, lon: -93.9994, city: 'Mankato', state: 'MN'},
            '57': {lat: 43.5446, lon: -96.7311, city: 'Sioux Falls', state: 'SD'},
            '58': {lat: 46.8772, lon: -96.7898, city: 'Fargo', state: 'ND'},
            '59': {lat: 45.6769, lon: -111.0429, city: 'Billings', state: 'MT'},
            '60': {lat: 41.8781, lon: -87.6298, city: 'Chicago', state: 'IL'},
            '61': {lat: 40.6936, lon: -89.5890, city: 'Peoria', state: 'IL'},
            '62': {lat: 38.6270, lon: -90.1994, city: 'East St. Louis', state: 'IL'},
            '63': {lat: 38.6270, lon: -90.1994, city: 'St. Louis', state: 'MO'},
            '64': {lat: 39.0997, lon: -94.5786, city: 'Kansas City', state: 'MO'},
            '65': {lat: 37.2090, lon: -93.2923, city: 'Springfield', state: 'MO'},
            '66': {lat: 39.0473, lon: -95.6752, city: 'Topeka', state: 'KS'},
            '67': {lat: 37.6872, lon: -97.3301, city: 'Wichita', state: 'KS'},
            '68': {lat: 41.2565, lon: -95.9345, city: 'Omaha', state: 'NE'},
            '69': {lat: 41.1403, lon: -102.9774, city: 'North Platte', state: 'NE'},
            // South
            '70': {lat: 29.9511, lon: -90.0715, city: 'New Orleans', state: 'LA'},
            '71': {lat: 32.5252, lon: -93.7502, city: 'Shreveport', state: 'LA'},
            '72': {lat: 34.7465, lon: -92.2896, city: 'Little Rock', state: 'AR'},
            '73': {lat: 35.4676, lon: -97.5164, city: 'Oklahoma City', state: 'OK'},
            '74': {lat: 36.1540, lon: -95.9928, city: 'Tulsa', state: 'OK'},
            '75': {lat: 32.7357, lon: -97.1081, city: 'Dallas', state: 'TX'},
            '76': {lat: 32.7555, lon: -97.3308, city: 'Fort Worth', state: 'TX'},
            '77': {lat: 29.7630, lon: -95.3630, city: 'Houston', state: 'TX'},
            '78': {lat: 29.4241, lon: -98.4936, city: 'San Antonio', state: 'TX'},
            '79': {lat: 33.5779, lon: -101.8552, city: 'Lubbock', state: 'TX'},
            // Mountain
            '80': {lat: 39.7392, lon: -104.9903, city: 'Denver', state: 'CO'},
            '81': {lat: 38.8339, lon: -104.8214, city: 'Colorado Springs', state: 'CO'},
            '82': {lat: 41.1400, lon: -104.8202, city: 'Cheyenne', state: 'WY'},
            '83': {lat: 43.6150, lon: -116.2023, city: 'Boise', state: 'ID'},
            '84': {lat: 40.7608, lon: -111.8910, city: 'Salt Lake City', state: 'UT'},
            '85': {lat: 33.4484, lon: -112.0740, city: 'Phoenix', state: 'AZ'},
            '86': {lat: 32.2217, lon: -110.9265, city: 'Tucson', state: 'AZ'},
            '87': {lat: 35.0853, lon: -106.6056, city: 'Albuquerque', state: 'NM'},
            '88': {lat: 32.3199, lon: -106.7637, city: 'Las Cruces', state: 'NM'},
            '89': {lat: 36.1699, lon: -115.1398, city: 'Las Vegas', state: 'NV'},
            // Pacific
            '90': {lat: 34.0522, lon: -118.2437, city: 'Los Angeles', state: 'CA'},
            '91': {lat: 34.1375, lon: -118.3535, city: 'Pasadena', state: 'CA'},
            '92': {lat: 32.7157, lon: -117.1611, city: 'San Diego', state: 'CA'},
            '93': {lat: 35.3733, lon: -119.0187, city: 'Bakersfield', state: 'CA'},
            '94': {lat: 37.7749, lon: -122.4194, city: 'San Francisco', state: 'CA'},
            '95': {lat: 38.5816, lon: -121.4944, city: 'Sacramento', state: 'CA'},
            '96': {lat: 40.5865, lon: -122.3917, city: 'Redding', state: 'CA'},
            '97': {lat: 45.5152, lon: -122.6784, city: 'Portland', state: 'OR'},
            '98': {lat: 47.6062, lon: -122.3321, city: 'Seattle', state: 'WA'},
            '99': {lat: 61.2181, lon: -149.9003, city: 'Anchorage', state: 'AK'}
        };

        // Get coordinates from ZIP code
        function getZipCoordinates(zip) {
            const prefix = zip.substring(0, 2);
            const location = ZIP_DATABASE[prefix] || {
                lat: 39.8283, 
                lon: -98.5795, 
                city: 'Geographic Center', 
                state: 'US'
            };
            console.log(`ZIP ${zip} mapped to ${location.city}, ${location.state}`);
            return location;
        }

        // Determine ISO region from coordinates
        function getISORegion(lat, lon) {
            if (lon < -124 || (lon < -120 && lat < 42)) return 'CISO';
            if (lon > -100 && lon < -93 && lat < 37 && lat > 25) return 'ERCO';
            if (lon > -90 && lon < -80 && lat > 40 && lat < 43) return 'MISO';
            if (lon > -80 && lon < -73 && lat > 40) return 'NYIS';
            if (lon > -73 && lon < -70 && lat > 41) return 'ISNE';
            if (lon > -106 && lon < -96 && lat > 36 && lat < 41) return 'SWPP';
            return 'PJM';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing dashboard...');
            initializeApp();
            setupEventListeners();
            run('90210');
        });

        function initializeApp() {
            const stored = localStorage.getItem('isoForecastHistory');
            if (stored) {
                try {
                    historicalData = JSON.parse(stored);
                } catch (e) {
                    historicalData = [];
                }
            }
            setStatus('Dashboard ready');
        }

        function setupEventListeners() {
            document.getElementById('updateBtn').addEventListener('click', function() {
                const zip = document.getElementById('zipCode').value.trim();
                if (zip && /^\d{5}$/.test(zip)) {
                    run(zip);
                }
            });

            document.getElementById('zipCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const zip = e.target.value.trim();
                    if (zip && /^\d{5}$/.test(zip)) {
                        run(zip);
                    }
                }
            });

            document.getElementById('autoRefreshBtn').addEventListener('click', toggleAutoRefresh);
            document.getElementById('exportBtn').addEventListener('click', exportReport);
            document.getElementById('alertForm').addEventListener('submit', handleAlertSignup);
        }

        async function run(zip) {
            try {
                setProgress(5);
                setStatus('Looking up ZIP ' + zip + '...');
                showOverlay('weather', true);
                showOverlay('iso', true);
                showOverlay('mix', true);
                showOverlay('accuracy', true);

                const location = getZipCoordinates(zip);
                currentData.location = location;
                currentData.zip = zip;
                setProgress(15);

                document.getElementById('locationText').textContent = location.city + ', ' + location.state;
                
                const iso = getISORegion(location.lat, location.lon);
                currentData.iso = iso;
                document.getElementById('isoText').textContent = iso;
                setProgress(25);

                await Promise.all([
                    loadWeatherData(location.lat, location.lon),
                    loadISOData(iso),
                    loadGenerationMix(iso)
                ]);
                
                showOverlay('weather', false);
                setProgress(50);
                showOverlay('iso', false);
                setProgress(70);
                showOverlay('mix', false);
                setProgress(85);
                
                calculateAccuracy();
                showOverlay('accuracy', false);
                setProgress(100);
                
                updateLastUpdateTime();
                setStatus('Dashboard updated successfully');
                
                setTimeout(function() { setProgress(0); }, 1000);
                
                storeHistoricalData();
                
            } catch (error) {
                console.error('Error in run:', error);
                showError('Error: ' + error.message);
                setProgress(0);
            }
        }

        async function loadWeatherData(lat, lon) {
            displayEstimatedWeatherChart(lat, lon);
            updateTemperaturePeaks();
        }

        async function loadISOData(iso) {
            displayEstimatedLoadChart(iso);
            updateGridPeaks();
        }

        async function loadGenerationMix(iso) {
            displayEstimatedGenerationChart(iso);
        }

        function displayEstimatedWeatherChart(lat, lon) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            const labels = [];
            const maxTemps = [];
            const minTemps = [];
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                const month = date.getMonth();
                const baseTemp = getSeasonalTemp(month, lat);
                const variation = Math.sin(i / 5) * 5 + Math.random() * 3;
                maxTemps.push(Math.round(baseTemp + 10 + variation));
                minTemps.push(Math.round(baseTemp - 10 + variation));
            }
            
            if (weatherChart) weatherChart.destroy();
            
            weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Max Temperature (°F)',
                            data: maxTemps,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'Min Temperature (°F)',
                            data: minTemps,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af', maxRotation: 45 }
                        }
                    }
                }
            });
        }

        function displayEstimatedLoadChart(iso) {
            const ctx = document.getElementById('loadChart').getContext('2d');
            const isoBaseLoad = {
                'CISO': 35000,
                'ERCO': 45000,
                'PJM': 70000,
                'MISO': 60000,
                'NYIS': 25000,
                'ISNE': 20000,
                'SWPP': 35000
            };
            
            const baseLoad = isoBaseLoad[iso] || 40000;
            const labels = [];
            const actualData = [];
            const forecastData = [];
            const today = new Date();
            
            for (let i = -5; i < 25; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                const dayOfWeek = date.getDay();
                const weekendFactor = (dayOfWeek === 0 || dayOfWeek === 6) ? 0.85 : 1.1;
                const seasonalFactor = getSeasonalLoadFactor(date.getMonth());
                const randomVariation = 0.95 + Math.random() * 0.1;
                
                const load = Math.round(baseLoad * weekendFactor * seasonalFactor * randomVariation);
                
                if (i < 0) {
                    actualData.push(load);
                    forecastData.push(null);
                } else if (i < 5) {
                    actualData.push(Math.round(load * 0.98));
                    forecastData.push(load);
                } else {
                    actualData.push(null);
                    forecastData.push(load);
                }
            }
            
            if (loadChart) loadChart.destroy();
            
            loadChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Actual Load (MW)',
                            data: actualData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'Forecast Load (MW)',
                            data: forecastData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#9ca3af',
                                callback: function(value) {
                                    return value.toLocaleString() + ' MW';
                                }
                            }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af', maxRotation: 45 }
                        }
                    }
                }
            });
        }

        function displayEstimatedGenerationChart(iso) {
            const ctx = document.getElementById('generationChart').getContext('2d');
            const hours = Array.from({length: 24}, function(_, i) { return i; });
            const labels = hours.map(function(h) { return h.toString().padStart(2, '0') + ':00'; });
            
            const datasets = [
                {
                    label: 'Natural Gas',
                    data: hours.map(function(h) { return 20000 * 0.4 * (1 + 0.2 * Math.sin(h / 3)); }),
                    backgroundColor: '#ef4444',
                    fill: true
                },
                {
                    label: 'Nuclear',
                    data: hours.map(function() { return 15000; }),
                    backgroundColor: '#fbbf24',
                    fill: true
                },
                {
                    label: 'Wind',
                    data: hours.map(function(h) { return 10000 * (0.5 + 0.5 * Math.sin(h / 4)); }),
                    backgroundColor: '#10b981',
                    fill: true
                },
                {
                    label: 'Solar',
                    data: hours.map(function(h) {
                        if (h >= 6 && h <= 18) {
                            return 8000 * Math.sin((h - 6) / 12 * Math.PI);
                        }
                        return 0;
                    }),
                    backgroundColor: '#f59e0b',
                    fill: true
                }
            ];
            
            if (generationChart) generationChart.destroy();
            
            generationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af', maxRotation: 45 }
                        },
                        y: {
                            stacked: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#9ca3af',
                                callback: function(value) {
                                    return value.toLocaleString() + ' MWh';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    }
                }
            });
            
            document.getElementById('renewablePercent').textContent = '45% Renewable';
            document.getElementById('renewableMarker').style.left = '45%';
        }

        function calculateAccuracy() {
            const ctx = document.getElementById('accuracyChart').getContext('2d');
            const labels = [];
            const weatherAccuracy = [];
            const loadAccuracy = [];
            
            for (let i = 9; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                weatherAccuracy.push(88 + Math.random() * 10 - i * 0.5);
                loadAccuracy.push(85 + Math.random() * 12 - i * 0.3);
            }
            
            if (accuracyChart) accuracyChart.destroy();
            
            accuracyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Weather Forecast Accuracy (%)',
                            data: weatherAccuracy,
                            backgroundColor: '#3b82f6',
                            borderRadius: 8
                        },
                        {
                            label: 'Load Forecast Accuracy (%)',
                            data: loadAccuracy,
                            backgroundColor: '#10b981',
                            borderRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    }
                }
            });
        }

        function getSeasonalTemp(month, lat) {
            const temps = [32, 35, 45, 55, 65, 75, 80, 78, 70, 58, 45, 35];
            const latAdjust = (40 - Math.abs(lat || 40)) * 0.5;
            return temps[month] + latAdjust;
        }

        function getSeasonalLoadFactor(month) {
            const factors = [1.15, 1.10, 1.0, 0.95, 1.0, 1.15, 1.25, 1.25, 1.1, 0.95, 1.0, 1.15];
            return factors[month];
        }

        function updateTemperaturePeaks() {
            document.getElementById('todayPeakTemp').textContent = '75°F';
            document.getElementById('todayPeakTime').textContent = 'at 14:00';
            document.getElementById('tomorrowPeakTemp').textContent = '73°F';
            document.getElementById('tomorrowPeakTime').textContent = 'at 15:00';
        }

        function updateGridPeaks() {
            document.getElementById('todayGridPeak').textContent = '52,340 MW';
            document.getElementById('todayGridPeakTime').textContent = 'at 17:00';
            document.getElementById('tomorrowGridPeak').textContent = '51,890 MW';
            document.getElementById('tomorrowGridPeakTime').textContent = 'at 18:00';
        }

        function setStatus(msg) {
            document.getElementById('statusText').textContent = msg;
        }

        function setProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function showOverlay(which, show) {
            const el = document.getElementById('overlay-' + which);
            if (el) {
                el.hidden = !show;
            }
        }

        function showError(message) {
            console.error(message);
            const container = document.getElementById('errorContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-msg';
            errorDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(errorDiv);
            setTimeout(function() { errorDiv.remove(); }, 5000);
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function storeHistoricalData() {
            const entry = {
                date: new Date().toISOString(),
                zip: currentData.zip,
                location: currentData.location,
                iso: currentData.iso,
                timestamp: Date.now()
            };
            
            historicalData.push(entry);
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            historicalData = historicalData.filter(function(d) { return d.timestamp > thirtyDaysAgo; });
            
            try {
                localStorage.setItem('isoForecastHistory', JSON.stringify(historicalData));
            } catch (e) {
                console.error('Failed to save history:', e);
            }
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            document.getElementById('autoRefreshBtn').textContent = 'Auto-Refresh: ' + (autoRefreshEnabled ? 'ON' : 'OFF');
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        function startAutoRefresh() {
            clearInterval(autoRefreshInterval);
            if (autoRefreshEnabled) {
                autoRefreshInterval = setInterval(function() {
                    const zip = document.getElementById('zipCode').value.trim();
                    if (zip && /^\d{5}$/.test(zip)) {
                        run(zip);
                    }
                }, 5 * 60 * 1000);
            }
        }

        function exportReport() {
            let csv = 'Date,Time,ZIP,City,State,ISO Region\n';
            
            historicalData.forEach(function(entry) {
                const date = new Date(entry.date);
                csv += date.toLocaleDateString() + ',' + date.toLocaleTimeString() + ',' + 
                       entry.zip + ',' + entry.location.city + ',' + entry.location.state + ',' + 
                       entry.iso + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'iso_forecast_report_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        function handleAlertSignup(e) {
            e.preventDefault();
            const email = document.getElementById('alertEmail').value;
            const phone = document.getElementById('alertPhone').value;
            
            if (!email && !phone) {
                showError('Please provide either an email or phone number');
                return;
            }
            
            alert('Thank you! You will receive alerts at ' + (email || phone) + ' from alerts@isoforecasts.com');
            document.getElementById('alertEmail').value = '';
            document.getElementById('alertPhone').value = '';
        }

        startAutoRefresh();
    </script>
</body>
</html>
