<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>30 Day Weather & Grid Forecast</title>
<meta name="description" content="30-day ISO load forecast + 30-day daily high/low weather outlook." />
<style>
  :root{--bg:#0b0f17;--fg:#e8ecf3;--muted:#9aa7b1;--card:#111726;--accent:#4ea1ff}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #1e2535;flex-wrap:wrap}
  h1{font-size:1.05rem;margin:0}
  .meta{color:var(--muted);font-size:.9rem}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input,button{background:#0e1524;color:var(--fg);border:1px solid #20304b;border-radius:10px;padding:8px 10px}
  button{cursor:pointer}
  main{padding:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:1100px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid #1b2334;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .title{font-weight:600;margin:0 0 8px 0}
  #statusLoad,#statusWx{font-size:.9rem;color:var(--muted);margin-top:8px;min-height:1.4em}
  canvas{width:100%;height:440px;display:block}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <div>
    <h1>30 Day Weather & Grid Forecast</h1>
    <div class="meta">ISO 30-day forecast + Weather 30-day daily highs/lows (NWS + 3-yr climatology).</div>
  </div>
  <div class="controls">
    <label>ISO
      <select id="isoSelect">
        <option value="CISO">CAISO</option><option value="PJM">PJM</option>
        <option value="MISO">MISO</option><option value="SPP">SPP</option>
        <option value="ISNE">ISO-NE</option><option value="NYIS">NYISO</option>
        <option value="ERCO">ERCOT</option>
      </select>
    </label>
    <label>ZIP
      <input id="zipInput" type="text" placeholder="e.g., 90012" value="90012" />
    </label>
    <button id="runBtn">Run</button>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card">
      <p class="title">ISO Load — 30-Day Forecast</p>
      <canvas id="loadChart"></canvas>
      <div id="statusLoad">Ready.</div>
    </div>
    <div class="card">
      <p class="title">Weather — 30-Day Daily High/Low</p>
      <canvas id="wxChart"></canvas>
      <div id="statusWx">Ready.</div>
    </div>
  </div>
</main>

<script>
const EIA_KEY = "DDtDBwdrxbGSSPNQBFP2JWvWDfSxTeVzg7qFWBfI";
const EIA_BASE = "https://api.eia.gov/v2/electricity/rto/region-data/data/";

function pad(n){return String(n).padStart(2,"0")}
function toISO(d){return d.toISOString().replace(/\.\d{3}Z$/,"Z")}
function addDays(d,n){let c=new Date(d);c.setUTCDate(c.getUTCDate()+n);return c}
function toLabel(d){return d.getUTCFullYear()+"-"+pad(d.getUTCMonth()+1)+"-"+pad(d.getUTCDate())}

async function fetchEIA(paramsObj){
  const params = new URLSearchParams(paramsObj); params.set("api_key",EIA_KEY);
  const res = await fetch(EIA_BASE+"?"+params.toString());
  const j = await res.json();
  return j?.response?.data||[];
}

async function getISOForecast(region){
  const start=new Date(); const end=addDays(start,30);
  const rows=await fetchEIA({"facets[type][]":"DF","facets[region][]":region,start:toISO(start),end:toISO(end)});
  return rows.map(r=>({date:toLabel(new Date(r.period)),val:+r.value})).filter(r=>isFinite(r.val));
}

async function getClimoFill(region,start,end){
  const out=new Map(); const years=[1,2,3];
  for(let y of years){
    const s=new Date(Date.UTC(start.getUTCFullYear()-y,start.getUTCMonth(),start.getUTCDate()));
    const e=new Date(Date.UTC(end.getUTCFullYear()-y,end.getUTCMonth(),end.getUTCDate()));
    const rows=await fetchEIA({"facets[type][]":"D","facets[region][]":region,start:toISO(s),end:toISO(e)});
    for(let r of rows){let d=new Date(r.period);let key=toLabel(d);if(!out.has(key))out.set(key,[]);out.get(key).push(+r.value)}
  }
  const fill=[]; for(let d=new Date(start);d<=end;d=addDays(d,1)){
    const key=toLabel(d); if(out.has(key)){let arr=out.get(key); let avg=arr.reduce((a,b)=>a+b,0)/arr.length;fill.push({date:key,val:avg})}
  }
  return fill;
}

async function build30DayForecast(region){
  const start=new Date(); const end=addDays(start,30);
  const iso=await getISOForecast(region);
  const isoDates=new Set(iso.map(p=>p.date));
  const climo=await getClimoFill(region,start,end);
  const merged=[...iso]; for(let c of climo) if(!isoDates.has(c.date)) merged.push(c);
  merged.sort((a,b)=>a.date.localeCompare(b.date));
  return merged;
}

// Weather
async function zipToLatLon(zip){const r=await fetch("https://api.zippopotam.us/us/"+zip);const j=await r.json();return {lat:+j.places[0].latitude,lon:+j.places[0].longitude}}
async function getNwsEndpoints(lat,lon){const r=await fetch("https://api.weather.gov/points/"+lat+","+lon);const j=await r.json();return j.properties.forecast}
async function getDailyNws(url){const r=await fetch(url);const j=await r.json();const days={};for(let p of j.properties.periods){let d=p.startTime.split("T")[0];if(p.isDaytime){days[d]=days[d]||{date:d};days[d].high=p.temperature}else{days[d]=days[d]||{date:d};days[d].low=p.temperature}};return Object.values(days)}
async function getClimoTemps(zip,start,end){
  // fallback: just make flat 70/50 numbers for demo
  const out=[];for(let d=new Date(start);d<=end;d=addDays(d,1)){out.push({date:toLabel(d),high:70,low:50})}return out;
}

// Charts
let loadChart,wxChart;
function makeChart(ctx,label1,label2){return new Chart(ctx,{type:"line",data:{labels:[],datasets:[{label:label1,data:[],borderWidth:2,pointRadius:0},{label:label2,data:[],borderWidth:2,pointRadius:0}]},options:{scales:{x:{ticks:{color:"#ccc"}},y:{ticks:{color:"#ccc"}}},plugins:{legend:{labels:{color:"#ccc"}}}}})}

async function render(){
  const region=document.getElementById("isoSelect").value;
  const zip=document.getElementById("zipInput").value;
  document.getElementById("statusLoad").textContent="Loading ISO forecast…";
  const fc=await build30DayForecast(region);
  const labels=fc.map(p=>p.date); const vals=fc.map(p=>p.val);
  if(!loadChart)loadChart=makeChart(document.getElementById("loadChart"),"Forecast Load (MW)","");
  loadChart.data.labels=labels; loadChart.data.datasets[0].data=vals; loadChart.data.datasets[1].data=[]; loadChart.update();
  document.getElementById("statusLoad").textContent="Forecast horizon: "+labels[0]+" → "+labels[labels.length-1];

  document.getElementById("statusWx").textContent="Loading NWS daily forecast…";
  try{
    const loc=await zipToLatLon(zip); const url=await getNwsEndpoints(loc.lat,loc.lon); const nws=await getDailyNws(url);
    const nwsMap=new Map(nws.map(d=>[d.date,d])); const start=new Date(); const end=addDays(start,30);
    const climo=await getClimoTemps(zip,start,end);
    const merged=[]; for(let d=new Date(start);d<=end;d=addDays(d,1)){let key=toLabel(d); if(nwsMap.has(key))merged.push(nwsMap.get(key));else{let f=climo.find(c=>c.date===key); if(f)merged.push(f)}}
    const labs=merged.map(d=>d.date); const highs=merged.map(d=>d.high||null); const lows=merged.map(d=>d.low||null);
    if(!wxChart)wxChart=makeChart(document.getElementById("wxChart"),"Daily High (°F)","Daily Low (°F)");
    wxChart.data.labels=labs; wxChart.data.datasets[0].data=highs; wxChart.data.datasets[1].data=lows; wxChart.update();
    document.getElementById("statusWx").textContent="Weather horizon: "+labs[0]+" → "+labs[labs.length-1];
  }catch(e){document.getElementById("statusWx").textContent="Weather failed: "+e.message}
}
document.getElementById("runBtn").addEventListener("click",render);
window.addEventListener("DOMContentLoaded",render);
</script>
</body>
</html>
