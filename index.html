<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>30 Day Weather & Grid Forecast — ISO Load (EIA + 30-Day Forecast)</title>
  <meta name="description" content="ISO hourly load from EIA v2 with 30-day outlook using available ISO forecasts, then climatology fill from the prior three years." />
  <style>
    :root{--bg:#0b0f17;--fg:#e8ecf3;--muted:#9aa7b1;--card:#111726;--accent:#4ea1ff}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #1e2535;flex-wrap:wrap}
    h1{font-size:1.05rem;margin:0}
    .meta{color:var(--muted);font-size:.9rem}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input,button{background:#0e1524;color:var(--fg);border:1px solid #20304b;border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    main{padding:16px}
    .card{background:var(--card);border:1px solid #1b2334;border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    #status{font-size:.9rem;color:var(--muted);margin-top:8px}
    canvas{width:100%;height:460px;display:block}
    .row{display:grid;gap:16px}
    @media(min-width:900px){.row{grid-template-columns:1fr}}
    footer{padding:12px 20px;color:var(--muted);font-size:.85rem}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>
  <header>
    <div>
      <h1>30 Day Weather & Grid Forecast — ISO Load (EIA)</h1>
      <div class="meta">Data: EIA v2 RTO Region Data — Actual (<code>type=D</code>) + Forecast (<code>type=DF</code>). Remainder filled by 3-year climatology.</div>
    </div>
    <div class="controls">
      <label>ISO
        <select id="isoSelect">
          <option value="CISO">CAISO</option>
          <option value="PJM">PJM</option>
          <option value="MISO">MISO</option>
          <option value="SPP">SPP</option>
          <option value="ISNE">ISO-NE</option>
          <option value="NYIS">NYISO</option>
          <option value="ERCO">ERCOT</option>
        </select>
      </label>
      <label>History (days)
        <input id="histDays" type="number" min="7" max="60" step="1" value="7" />
      </label>
      <button id="refreshBtn">Run</button>
    </div>
  </header>

  <main>
    <div class="row">
      <div class="card">
        <canvas id="chart"></canvas>
        <div id="status">Ready.</div>
      </div>
    </div>
  </main>

  <footer>
    EIA key is embedded per your request. Forecast horizon: 30 days. Climatology = average of same month-day-hour from the past 3 years (available data only).
  </footer>

<script>
/** ---------- Config ---------- **/
const EIA_API_KEY = 'DDtDBwdrxbGSSPNQBFP2JWvWDfSxTeVzg7qFWBfI'; // hard-coded at your request
const EIA_BASE = 'https://api.eia.gov/v2/electricity/rto/region-data/data/';
const STATUS = document.getElementById('status');
const isoSelect = document.getElementById('isoSelect');
const histDaysInput = document.getElementById('histDays');
const refreshBtn = document.getElementById('refreshBtn');

/** ---------- Helpers ---------- **/
const pad = (n) => String(n).padStart(2,'0');
function toISOz(d) {
  return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}T${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:00Z`;
}
function addHours(d, h){ return new Date(d.getTime() + h*3600*1000); }
function clone(d){ return new Date(d.getTime()); }
function fmtRange(a,b){
  return `${a.toLocaleString()} — ${b.toLocaleString()}`;
}

/** ---------- EIA fetch with paging ---------- **/
async function fetchEIA(paramsObj, maxPages=10) {
  const params = new URLSearchParams(paramsObj);
  params.set('api_key', EIA_API_KEY);
  // Default: sort by period ascending for time series
  if (!params.get('sort[0][column]')) {
    params.set('sort[0][column]', 'period');
    params.set('sort[0][direction]', 'asc');
  }
  let out=[], offset=0, length=5000;
  for (let i=0;i<maxPages;i++){
    params.set('offset', offset);
    params.set('length', length);
    const url = `${EIA_BASE}?${params.toString()}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`EIA ${res.status} ${res.statusText}`);
    const json = await res.json();
    const rows = json?.response?.data || [];
    out = out.concat(rows);
    const total = json?.response?.total ?? rows.length;
    offset += rows.length;
    if (offset >= total || rows.length === 0) break;
  }
  return out;
}

/** ---------- Load Actuals (type=D) ---------- **/
async function getActuals(region, start, end){
  const rows = await fetchEIA({
    'facets[type][]':'D',
    'facets[region][]': region,
    start: toISOz(start),
    end: toISOz(end)
  });
  return rows
    .map(r => ({ t: new Date(r.period), v: (r.value==null?null:Number(r.value)) }))
    .filter(p => isFinite(p.t) && p.v!=null && isFinite(p.v));
}

/** ---------- Load ISO Forecast if available (type=DF) ---------- **/
async function getISOForecast(region, start, end){
  try{
    const rows = await fetchEIA({
      'facets[type][]':'DF',
      'facets[region][]': region,
      start: toISOz(start),
      end: toISOz(end)
    });
    const series = rows
      .map(r => ({ t: new Date(r.period), v: (r.value==null?null:Number(r.value)) }))
      .filter(p => isFinite(p.t) && p.v!=null && isFinite(p.v));
    // Some ISOs only publish day-ahead; that’s fine, we’ll fill the rest
    return series;
  }catch(e){
    console.warn('DF fetch failed (continuing with climatology):', e);
    return [];
  }
}

/** ---------- Climatology (3-year average for month-day-hour) ---------- **/
async function getClimatologyFill(region, targetStart, targetEnd) {
  // For the future range [targetStart, targetEnd], fetch same range for past 3 years’ *actuals*.
  const years = [1,2,3]; // lookback years
  // Build a map: key = 'MM-DD-HH' -> array of values across years
  const buckets = new Map();

  // Helper to push into bucket
  const pushBucket = (d, val) => {
    const k = `${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}-${pad(d.getUTCHours())}`;
    const arr = buckets.get(k) || [];
    arr.push(val);
    buckets.set(k, arr);
  };

  // Pull actuals for each lookback year corresponding to the FUTURE window dates, shifted by -N years
  for (const y of years) {
    const s = new Date(Date.UTC(targetStart.getUTCFullYear()-y, targetStart.getUTCMonth(), targetStart.getUTCDate(), targetStart.getUTCHours(), 0, 0));
    const e = new Date(Date.UTC(targetEnd.getUTCFullYear()-y, targetEnd.getUTCMonth(), targetEnd.getUTCDate(), targetEnd.getUTCHours(), 0, 0));
    try{
      const ser = await getActuals(region, s, e);
      for (const p of ser) pushBucket(p.t, p.v);
    }catch(err){
      console.warn(`Climatology fetch year -${y} failed`, err);
    }
  }

  // Build hourly series across target window using mean of available values in the bucket
  const out = [];
  for (let t = clone(targetStart); t <= targetEnd; t = addHours(t,1)) {
    const k = `${pad(t.getUTCMonth()+1)}-${pad(t.getUTCDate())}-${pad(t.getUTCHours())}`;
    const arr = buckets.get(k) || [];
    if (arr.length > 0) {
      const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
      out.push({ t: clone(t), v: mean });
    } else {
      // Fallback: if bucket empty (rare), leave gap
      out.push({ t: clone(t), v: null });
    }
  }
  // Clean nulls (conservative: drop nulls; chart will simply not connect over gaps)
  return out.filter(p => p.v!=null && isFinite(p.v));
}

/** ---------- Merge DF with Climatology to full 30 days ---------- **/
async function build30DayForecast(region) {
  const now = new Date();
  const startF = addHours(now, 1); // next hour forward
  const endF = addHours(now, 24*30); // 30 days ahead
  // Try ISO DF first
  const df = await getISOForecast(region, startF, endF);
  const lastDF = df.length ? df[df.length-1].t : addHours(now, 0);
  // If DF doesn’t reach full horizon, fill remaining with climatology
  const needStart = addHours(lastDF, 1);
  let clima = [];
  if (needStart <= endF) {
    clima = await getClimatologyFill(region, needStart, endF);
  }
  // Merge, ensuring no overlap duplicates
  const dfMap = new Map(df.map(p => [+p.t, p]));
  const merged = [...df];
  for (const p of clima) if (!dfMap.has(+p.t)) merged.push(p);
  // Ensure sorted
  merged.sort((a,b)=>a.t - b.t);
  return { series: merged, dfHours: df.length };
}

/** ---------- Chart ---------- **/
let chart;
function ensureChart(ctx){
  if (chart) return chart;
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels:[], datasets:[
      {
        label:'Actual Load (MW)',
        data:[],
        borderWidth:2,
        tension:0.2,
        pointRadius:0
      },
      {
        label:'ISO Forecast (MW)',
        data:[],
        borderWidth:2,
        borderDash:[6,6],   /* dashed as requested */
        tension:0.2,
        pointRadius:0
      }
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index', intersect:false},
      plugins:{
        legend:{ labels:{ color:'#dbe6f2', usePointStyle:true } },
        tooltip:{
          callbacks:{
            title:(items)=> items?.length ? new Date(items[0].raw.x).toLocaleString() : '',
            label:(item)=> ` ${item.dataset.label}: ${item.raw.y.toLocaleString()}`
          }
        }
      },
      scales:{
        x:{ type:'time', time:{unit:'day'}, ticks:{color:'#b8c2cc'}, grid:{color:'rgba(255,255,255,0.06)'} },
        y:{ ticks:{color:'#b8c2cc'}, grid:{color:'rgba(255,255,255,0.06)'} }
      }
    }
  });
  return chart;
}

function updateChart(actuals, forecast){
  const ctx = document.getElementById('chart').getContext('2d');
  const c = ensureChart(ctx);
  c.data.datasets[0].data = actuals.map(p=>({x:p.t, y:p.v}));
  c.data.datasets[1].data = forecast.map(p=>({x:p.t, y:p.v}));
  c.update();
}

/** ---------- Main render ---------- **/
async function render(){
  const region = isoSelect.value;
  const histDays = Math.max(7, Math.min(60, parseInt(histDaysInput.value||'7',10)));

  const now = new Date();
  const histStart = addHours(now, -24*histDays);
  const histEnd = now;

  STATUS.textContent = `Loading ${region} actuals (${histDays} days) and 30-day forecast from EIA…`;
  try{
    const [actuals, forecastObj] = await Promise.all([
      getActuals(region, histStart, histEnd),
      build30DayForecast(region)
    ]);
    const { series: forecast, dfHours } = forecastObj;

    updateChart(actuals, forecast);
    const aMsg = actuals.length ? fmtRange(actuals[0].t, actuals[actuals.length-1].t) : 'no actuals';
    const fMsg = forecast.length ? fmtRange(forecast[0].t, forecast[forecast.length-1].t) : 'no forecast';
    STATUS.textContent = `Actuals: ${aMsg}. Forecast: ${fMsg}. ISO DF hours used: ${dfHours}. Climatology filled remaining using prior 3 years.`;
  }catch(err){
    console.error(err);
    STATUS.textContent = `Error: ${err.message}`;
  }
}

refreshBtn.addEventListener('click', render);
window.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
