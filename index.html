<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>US ISO Demand — 7-Day Lookback & 10-Day Outlook</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root { --bg:#0b0d10; --fg:#e8eef6; --muted:#8aa0b6; --card:#12161b; --line:#1f2833; --accent:#3fa9f5; --bad:#ffd6d6; --ok:#c9ffd9; }
  @media (prefers-color-scheme: light){
    :root { --bg:#fff; --fg:#0b1320; --muted:#5a6b7b; --card:#f6f8fb; --line:#e4e7ef; --accent:#1565d8; --bad:#b00020; --ok:#1b7f4a; }
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line);padding:14px 18px}
  h1{margin:0;font-size:18px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  select,button{background:#0f141a;color:var(--fg);border:1px solid #263041;border-radius:8px;padding:8px 10px}
  button{cursor:pointer}
  main{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  canvas{width:100%;height:300px}
  .pill{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:6px 10px;border:1px solid var(--line);font-size:12px;background:#101826}
  .pill.ok{color:var(--ok)}
  .pill.bad{color:var(--bad)}
  .small{color:var(--muted);font-size:12px;margin-top:6px}
  footer{padding:12px 16px;border-top:1px solid var(--line);color:var(--muted)}
  a{color:var(--accent)}
</style>

<!-- Libraries with fallbacks -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js" defer></script>
<script>
  // Fallback loaders if a CDN hiccups
  (function(){
    function add(src){ const s=document.createElement('script'); s.src=src; s.defer=true; document.head.appendChild(s); }
    window.addEventListener('error', e=>{
      const u = (e?.target && e.target.tagName==='SCRIPT') ? e.target.src : '';
      if (u.includes('luxon') && !window.__luxonFx){ window.__luxonFx=true; add('https://unpkg.com/luxon@3.4.4/build/global/luxon.min.js'); }
      if (u.includes('chart.umd') && !window.__chartFx){ window.__chartFx=true; add('https://unpkg.com/chart.js@4.4.3/dist/chart.umd.min.js'); }
      if (u.includes('chartjs-adapter-luxon') && !window.__adapterFx){ window.__adapterFx=true; add('https://unpkg.com/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js'); }
    }, true);
  })();
</script>
</head>
<body>
<header>
  <h1>US ISO Demand — 7-Day Lookback & 10-Day Outlook</h1>
  <div class="controls">
    <label>ISO:
      <select id="iso">
        <option value="CISO">CAISO</option>
        <option value="ERCO">ERCOT</option>
        <option value="MISO">MISO</option>
        <option value="PJM">PJM</option>
        <option value="NYIS">NYISO</option>
        <option value="ISNE">ISO-NE</option>
        <option value="SWPP">SPP</option>
      </select>
    </label>
    <button id="refresh">Refresh</button>
    <span id="status" class="pill">Ready</span>
  </div>
  <div class="small">Demand: EIA-930 (v2) • Weather: Visual Crossing</div>
</header>

<main>
  <section class="card">
    <h2 style="margin:0 0 8px">7-Day Lookback — Demand & Temperature</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
      <span id="eiaPill" class="pill">EIA …</span>
      <span id="wxPill" class="pill">Weather …</span>
    </div>
    <canvas id="lookChart"></canvas>
    <div id="lookNote" class="small"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 8px">10-Day Outlook — Hourly Temp & Peak Hour (proxy)</h2>
    <canvas id="outChart"></canvas>
    <div id="peakNote" class="small"></div>
  </section>
</main>

<footer>Data requests are minimized and retried gently to avoid 500/429 errors. Charts downsample automatically.</footer>

<script>
(() => {
  // ===== Keys (force new EIA key if an old one lingers) =====
  const EIA_NEW = "UCb8mhqSXXtvgaHkGD6d1yw3j56hR541PXrbdZ49";
  const EIA_OLD = new Set(["DDtDBwdrxbGSSPNQBFP2JWvWDfSxTeVzg7qFWBfI"]);
  const VC_KEY  = "4NE3QKKV57NYKGH7F9KM4NMVL";
  (function ensureKeys(){
    const k = localStorage.getItem("EIA_API_KEY");
    if (!k || EIA_OLD.has(k)) localStorage.setItem("EIA_API_KEY", EIA_NEW);
    if (!localStorage.getItem("VC_API_KEY")) localStorage.setItem("VC_API_KEY", VC_KEY);
  })();

  // ===== ISO meta (centroids for weather) =====
  const ISO = {
    CISO:{name:"CAISO", lat:36.77, lon:-119.42, tz:"America/Los_Angeles"},
    ERCO:{name:"ERCOT", lat:31.00, lon:-99.00,  tz:"America/Chicago"},
    MISO:{name:"MISO",  lat:41.88, lon:-87.63,  tz:"America/Chicago"},
    PJM: {name:"PJM",   lat:39.95, lon:-75.16,  tz:"America/New_York"},
    NYIS:{name:"NYISO", lat:40.71, lon:-74.00,  tz:"America/New_York"},
    ISNE:{name:"ISO-NE",lat:42.36, lon:-71.06,  tz:"America/New_York"},
    SWPP:{name:"SPP",   lat:35.47, lon:-97.52,  tz:"America/Chicago"},
  };

  // ===== Helpers =====
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  function setPill(el, ok, text){ el.textContent=text; el.className="pill "+(ok?"ok":"bad"); }
  function thin(arr, step){ if (step<=1) return arr; const out=[]; for(let i=0;i<arr.length;i+=step) out.push(arr[i]); return out; }
  // Abort stale runs when switching ISO fast
  let runToken = 0;

  async function loadLibs(){
    for (let i=0;i<30 && !(window.Chart && window.luxon); i++) await sleep(100);
    if (!(window.Chart && window.luxon)) throw new Error("Chart.js/Luxon failed to load");
  }

  // ===== Unified fetch with smart retries (handles 429/500) =====
  async function getJSON(url, {tries=4, backoff=350} = {}){
    let last;
    for (let i=0;i<tries;i++){
      try{
        const res = await fetch(url, {mode:"cors", cache:"no-store"});
        if (res.status===429){
          const ra = Number(res.headers.get("retry-after")) || (1<<i);
          await sleep(ra*1000);
          continue;
        }
        if (!res.ok) throw new Error(res.status+" "+res.statusText);
        return await res.json();
      }catch(e){ last=e; await sleep(backoff*(i+1)); }
    }
    throw last || new Error("Request failed");
  }

  // ===== EIA (minimized payload) =====
  // Strategy:
  // 1) One small "latest" request (length=220) in UTC hourly; trim to last 7d.
  // 2) If empty or 500/503, try same in local-hourly.
  // 3) If still empty, page in tiny slices (length=40, up to 6 pages) and merge.
  function eiaURL({respondent, frequency="hourly", length=220, offset=0, withSort=true}){
    const key = localStorage.getItem("EIA_API_KEY") || EIA_NEW;
    const u = new URL("https://api.eia.gov/v2/electricity/rto/region-data/data/");
    u.searchParams.set("api_key", key);
    u.searchParams.set("frequency", frequency);
    u.searchParams.append("data[]","value");          // DO NOT request period explicitly
    u.searchParams.append("facets[respondent][]", respondent);
    u.searchParams.append("facets[type][]", "D");
    if (withSort){ u.searchParams.append("sort[0][column]", "period"); u.searchParams.append("sort[0][direction]", "desc"); }
    u.searchParams.set("offset", String(offset));
    u.searchParams.set("length", String(length));
    return u.toString();
  }

  async function eiaLatest7dLite(respondent){
    const DateTime = luxon.DateTime;
    const cutoff = DateTime.utc().minus({hours: 168});
    const patterns = [
      {freq:"hourly", len:220, sort:true},
      {freq:"local-hourly", len:220, sort:true},
    ];
    // single-shot attempts
    for (const p of patterns){
      try{
        const j = await getJSON(eiaURL({respondent, frequency:p.freq, length:p.len, withSort:p.sort}));
        const rows = j?.response?.data || [];
        if (rows.length){
          const out = rows
            .map(r=>({t: DateTime.fromISO(String(r.period), {zone:"utc"}), v:Number(r.value)}))
            .filter(x=>x.t.isValid && x.t >= cutoff)
            .sort((a,b)=>a.t - b.t);
          if (out.length>=120) return {rows: out, freq:p.freq};
        }
      }catch(e){ /* try next pattern */ }
    }
    // tiny paging fallback
    const collected = [];
    for (const freq of ["hourly","local-hourly"]){
      for (const sort of [true,false]){
        for (let page=0; page<6; page++){
          const url = eiaURL({respondent, frequency:freq, length:40, offset:page*40, withSort:sort});
          let rows=[];
          try{ const j=await getJSON(url, {tries:3, backoff:250}); rows = j?.response?.data || []; }
          catch(e){ continue; }
          for (const r of rows){
            const t = DateTime.fromISO(String(r.period), {zone:"utc"});
            if (t.isValid) collected.push({t, v:Number(r.value)});
          }
          await sleep(120);
        }
        const recent = collected.filter(x=>x.t >= cutoff).sort((a,b)=>a.t - b.t);
        if (recent.length>=100) return {rows: recent, freq:`${freq}${sort?'+sort':''}`};
      }
    }
    const recent = collected.filter(x=>x.t >= cutoff).sort((a,b)=>a.t - b.t);
    if (recent.length) return {rows: recent, freq:"mixed"};
    throw new Error("EIA 7-day data unavailable after fallbacks.");
  }

  // ===== Visual Crossing (one call for 7d history + 10d forecast) =====
  async function getVC(lat, lon, tz){
    const key = localStorage.getItem("VC_API_KEY") || VC_KEY;
    const DateTime = luxon.DateTime;
    const now = DateTime.now().setZone(tz).startOf("hour");
    const start = now.minus({days:7}).toISODate();   // YYYY-MM-DD
    const end   = now.plus({days:10}).toISODate();   // YYYY-MM-DD
    const base = "https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline";
    // one combined timeline reduces requests (and 429 risk)
    const url = `${base}/${lat},${lon}/${start}/${end}?unitGroup=us&include=hours,days&elements=datetime,temp,tempmax,tempmin&key=${encodeURIComponent(key)}`;
    try{
      return await getJSON(url, {tries:5, backoff:500});    // exponential backoff handles 429
    }catch(e){
      // fallback to two smaller calls if provider rejects combined range
      const last7  = `${base}/${lat},${lon}/last7days?unitGroup=us&include=hours,days&elements=datetime,temp,tempmax,tempmin&key=${encodeURIComponent(key)}`;
      const next10 = `${base}/${lat},${lon}/next10days?unitGroup=us&include=hours,days&elements=datetime,temp,tempmax,tempmin&key=${encodeURIComponent(key)}`;
      const [a,b] = await Promise.all([ getJSON(last7,{tries:4,backoff:400}), getJSON(next10,{tries:4,backoff:400}) ]);
      // merge hours/days into one object to keep downstream code simple
      return { timezone: tz, address:`${lat},${lon}`, resolvedAddress:`${lat},${lon}`,
               hours:[...(a.hours||[]), ...(b.hours||[])], days:[...(a.days||[]), ...(b.days||[])] };
    }
  }

  // ===== Charts =====
  function makeChart(ctx, cfg){
    if (ctx.__chart) ctx.__chart.destroy();
    // Built-in decimation keeps rendering fast while preserving shape
    cfg.options = cfg.options || {};
    cfg.options.plugins = cfg.options.plugins || {};
    cfg.options.plugins.decimation = { enabled:true, algorithm:'lttb', samples: 200 }; // cap ~200 drawn points
    ctx.__chart = new Chart(ctx, cfg);
    return ctx.__chart;
  }
  function baseOpts(){
    return {
      responsive:true, maintainAspectRatio:false, parsing:false, animation:false,
      scales:{
        x:{type:'time', time:{unit:'hour'}},
        y:{title:{display:true,text:'MW'}},
        y1:{position:'right', title:{display:true,text:'°F'}, grid:{display:false}}
      },
      plugins:{ legend:{display:true} }
    };
  }
  function computePeakHour(hours){
    // simple proxy: hottest hour wins; tie -> later hour
    return hours.reduce((m,h)=>!m||h.temp>m.temp||(h.temp===m.temp&&h.t>m.t)?h:m,null);
  }

  // ===== Render flow =====
  async function render(){
    const myToken = ++runToken; // abort guard
    await loadLibs();

    const code = document.getElementById("iso").value;
    const meta = ISO[code];
    const status = document.getElementById("status");
    status.textContent = `Loading ${meta.name}…`;

    const eiaPill = document.getElementById("eiaPill");
    const wxPill  = document.getElementById("wxPill");

    let eia=null, vc=null;

    // EIA (reduced data)
    try{
      eia = await eiaLatest7dLite(code);
      if (runToken!==myToken) return;
      setPill(eiaPill, true, `EIA OK (${eia.freq})`);
    }catch(e){
      console.error("EIA error:", e);
      setPill(eiaPill, false, "EIA error");
    }

    // Weather (single combined call; auto 429 handling)
    try{
      vc = await getVC(meta.lat, meta.lon, meta.tz);
      if (runToken!==myToken) return;
      setPill(wxPill, true, "Weather OK");
    }catch(e){
      console.error("Weather error:", e);
      setPill(wxPill, false, "Weather error");
      vc = null;
    }

    const DateTime = luxon.DateTime;

    // Build lookback series (downsample to every 2 hours to cut drawing cost)
    const lookCtx = document.getElementById("lookChart").getContext("2d");
    const lb = {labels:[], datasets:[]};
    if (eia?.rows?.length){
      const eiaThin = thin(eia.rows, 2); // 2-hour step
      lb.labels = eiaThin.map(p=>p.t.toISO());
      lb.datasets.push({label:"Demand (MW)", data:eiaThin.map(p=>p.v), yAxisID:"y", borderWidth:1.6, pointRadius:0, tension:0.2});
    }
    if (vc?.hours?.length){
      const h = vc.hours
        .map(x=>({t: DateTime.fromISO(x.datetime, {zone:meta.tz}), v:Number(x.temp)}))
        .filter(o=>o.t.isValid)
        .sort((a,b)=>a.t-b.t);
      const cutoffLocal = DateTime.now().setZone(meta.tz).minus({days:7});
      const last7 = h.filter(o=>o.t >= cutoffLocal);
      const tThin = thin(last7, 2); // 2-hour
      lb.datasets.push({label:"Temp (°F)", data:tThin.map(o=>({x:o.t.toISO(), y:o.v})), yAxisID:"y1",
                        borderWidth:1.2, pointRadius:0, borderDash:[4,3], tension:0.2});
    }
    makeChart(lookCtx, {type:'line', data:lb, options:baseOpts()});
    document.getElementById("lookNote").textContent =
      `${meta.name}: ${eia?.rows?.length||0} demand hrs (shown ~${Math.ceil((eia?.rows?.length||0)/2)}) • `
      + `${vc?.hours?.length? 'weather ok':'weather n/a'}`;

    // Outlook (use hourly temps only; downsample ~ every 2 hours)
    const outCtx = document.getElementById("outChart").getContext("2d");
    const out = {labels:[], datasets:[]};
    if (vc?.hours?.length){
      const future = vc.hours
        .map(x=>({ t: DateTime.fromISO(x.datetime, {zone:meta.tz}), temp:Number(x.temp)}))
        .filter(o=>o.t.isValid && o.t >= DateTime.now().setZone(meta.tz))
        .sort((a,b)=>a.t-b.t);
      const fThin = thin(future, 2);
      out.labels = fThin.map(h=>h.t.toISO());
      out.datasets.push({label:"Temp (°F)", data:fThin.map(h=>h.temp), yAxisID:"y1", borderWidth:1.2, pointRadius:0, tension:0.2});

      // daily min/max ribbons from days array
      if (Array.isArray(vc.days)){
        const mins=[], maxs=[];
        vc.days.forEach(d=>{
          const mid = DateTime.fromISO(d.datetime, {zone:meta.tz}).startOf('day').plus({hours:12});
          if (mid.isValid){
            if (d.tempmin!=null) mins.push({x:mid.toISO(), y:Number(d.tempmin)});
            if (d.tempmax!=null) maxs.push({x:mid.toISO(), y:Number(d.tempmax)});
          }
        });
        out.datasets.push({label:"Daily Min (°F)", data:mins, yAxisID:"y1", borderWidth:1, pointRadius:0, borderDash:[4,4], tension:0.2});
        out.datasets.push({label:"Daily Max (°F)", data:maxs, yAxisID:"y1", borderWidth:1, pointRadius:0, borderDash:[4,4], tension:0.2});
      }

      const peak = (()=>{
        // use full-resolution (not thinned) for the heuristic
        const fut = vc.hours
          .map(x=>({ t: DateTime.fromISO(x.datetime, {zone:meta.tz}), temp:Number(x.temp)}))
          .filter(o=>o.t.isValid && o.t >= DateTime.now().setZone(meta.tz));
        return computePeakHour(fut);
      })();
      document.getElementById("peakNote").textContent = peak
        ? `Predicted peak (temp-proxy): ${peak.t.toFormat("ccc, L/d h a")} at ≈ ${Math.round(peak.temp)}°F`
        : "Predicted peak hour unavailable.";
    } else {
      document.getElementById("peakNote").textContent = "Predicted peak hour unavailable (weather failed).";
    }
    makeChart(outCtx, {type:'line', data:out, options:baseOpts()});

    status.textContent = `Done: ${meta.name}`;
  }

  // ===== UI wires =====
  window.addEventListener("DOMContentLoaded", ()=>{
    const go = ()=>render().catch(err=>{
      console.error(err);
      const s=document.getElementById("status"); s.className='pill bad'; s.textContent='Load error — see console';
    });
    document.getElementById("iso").addEventListener("change", go);
    document.getElementById("refresh").addEventListener("click", go);
    go();
  });
})();
</script>
</body>
</html>
