<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>US ISO Demand — 7-Day Lookback & 10-Day Outlook</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b1220;color:#e6eef9}
    header{padding:16px 20px;border-bottom:1px solid #1c2942;display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    h1{font-size:18px;margin:0;font-weight:600}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .controls label{font-size:12px;opacity:.9}
    .controls input,.controls select,button{
      background:#0f1730;border:1px solid #223357;border-radius:8px;color:#e6eef9;padding:8px 10px;font-size:13px
    }
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;padding:16px}
    .card{background:#0f1730;border:1px solid #223357;border-radius:14px;overflow:hidden}
    .card header{border:0;padding:12px 14px;background:#0f1730}
    .card h2{margin:0;font-size:14px;font-weight:600}
    .meta{font-size:12px;opacity:.8}
    canvas{width:100%;height:260px}
    .err{color:#ffb4b4;font-size:12px;padding:8px 14px;border-top:1px solid #223357}
    .ok{color:#99ffc9}
    .small{font-size:12px;opacity:.8}
    footer{padding:10px 16px;border-top:1px solid #1c2942;font-size:12px;opacity:.8}
  </style>

  <!-- stable CDN libs (no CORB / 404) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js" defer></script>
</head>
<body>
  <header>
    <h1>US ISO Demand — 7-Day Lookback & 10-Day Outlook</h1>
    <div class="controls">
      <label>ISO
        <select id="iso">
          <option value="CISO">CAISO</option>
          <option value="ERCO">ERCOT</option>
          <option value="MISO">MISO</option>
          <option value="PJM">PJM</option>
          <option value="NYIS">NYISO</option>
          <option value="ISNE">ISO-NE</option>
          <option value="SWPP">SPP</option>
        </select>
      </label>
      <label>EIA key
        <input id="eiaKey" size="42" placeholder="EIA API key" />
      </label>
      <label>Weather key (Visual Crossing)
        <input id="wxKey" size="36" placeholder="Visual Crossing key" />
      </label>
      <button id="save">Save Keys</button>
      <span class="small">Tip: you can also set <code>?eiaKey=...&wxKey=...</code> in the URL.</span>
    </div>
  </header>

  <div class="grid" id="grid"></div>
  <footer>EIA demand (past 7 days, hourly). Weather by Visual Crossing (hourly + daily, next 10 days). Peak outlook hour = hottest forecast hour local time.</footer>

<script>
(() => {
  const ISO_META = {
    CISO: { name: "CAISO", lat: 36.77, lon: -119.42, tz: "America/Los_Angeles" },
    ERCO: { name: "ERCOT", lat: 31.00, lon: -97.00, tz: "America/Chicago" },
    MISO: { name: "MISO",  lat: 41.50, lon: -88.00, tz: "America/Chicago" },
    PJM:  { name: "PJM",   lat: 39.90, lon: -77.00, tz: "America/New_York" },
    NYIS: { name: "NYISO", lat: 42.95, lon: -75.53, tz: "America/New_York" },
    ISNE: { name: "ISO-NE",lat: 42.36, lon: -71.06, tz: "America/New_York" },
    SWPP: { name: "SPP",   lat: 36.10, lon: -97.50, tz: "America/Chicago" },
  };

  const QS = new URLSearchParams(location.search);
  const EIA_OLD = "DDtDBwdrxbGSSPNQBFP2JWvWDfSxTeVzg7qFWBfI";
  const EIA_DEFAULT = QS.get("eiaKey") || localStorage.getItem("EIA_API_KEY") || "UCb8mhqSXXtvgaHkGD6d1yw3j56hR541PXrbdZ49";
  const WX_DEFAULT  = QS.get("wxKey")  || localStorage.getItem("WX_API_KEY")  || "4NE3QKKV57NYKGH7F9KM4NMVL";

  // force-migrate if the old key is still present in storage
  if (localStorage.getItem("EIA_API_KEY") === EIA_OLD) {
    localStorage.setItem("EIA_API_KEY", EIA_DEFAULT);
    console.warn("Replaced old EIA key from localStorage.");
  }

  // wire inputs
  const elISO   = document.getElementById("iso");
  const elEIA   = document.getElementById("eiaKey");
  const elWX    = document.getElementById("wxKey");
  const elSave  = document.getElementById("save");
  elEIA.value = EIA_DEFAULT;
  elWX.value  = WX_DEFAULT;

  elSave.onclick = () => {
    localStorage.setItem("EIA_API_KEY", elEIA.value.trim());
    localStorage.setItem("WX_API_KEY",  elWX.value.trim());
    location.reload();
  };

  // chart helpers
  function makeCard(id, title, subtitle) {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <header><h2>${title}</h2><div class="meta">${subtitle||""}</div></header>
      <canvas id="${id}"></canvas>
      <div class="err" id="${id}-err" style="display:none"></div>`;
    return card;
  }
  function showErr(id, msg) {
    const el = document.getElementById(id+"-err");
    el.style.display = "block";
    el.textContent = msg;
  }

  // safe fetch with backoff + special handling for EIA 500s
  async function fetchWithRetry(url, {tries=[1,2,3], delay=1200, onBeforeTry} = {}) {
    let lastErr;
    for (let i=0;i<tries.length;i++){
      try{
        if (onBeforeTry) await onBeforeTry(i);
        const res = await fetch(url, {headers:{Accept:"application/json"}});
        if (!res.ok) {
          const txt = await res.text().catch(()=>res.statusText);
          throw new Error(`${res.status} ${res.statusText} ${txt?(" :: "+txt.slice(0,120)):''}`);
        }
        return await res.json();
      }catch(e){
        lastErr = e;
        await new Promise(r=>setTimeout(r, delay*tries[i]));
      }
    }
    throw lastErr;
  }

  // --- EIA: Hourly demand (7d lookback) ---
  function eiaURL({key, respondent, useLocal, length=200, sortDesc=true}) {
    const u = new URL("https://api.eia.gov/v2/electricity/rto/region-data/data/");
    u.searchParams.set("api_key", key);
    u.searchParams.set("frequency", useLocal ? "local-hourly" : "hourly");
    // ONLY request numeric data columns; period is always included by default
    u.searchParams.append("data[]", "value");
    u.searchParams.append("facets[respondent][]", respondent);
    u.searchParams.append("facets[type][]", "D");
    if (sortDesc) {
      u.searchParams.append("sort[0][column]", "period");
      u.searchParams.append("sort[0][direction]", "desc");
    }
    u.searchParams.set("offset", "0");
    u.searchParams.set("length", String(length));
    return u.toString();
  }

  async function eiaLatest7d(respondent, tz, key) {
    // try descending / length 200, then 120, then 60, then try no sort
    const attempts = [
      {len:200, sort:true},
      {len:120, sort:true},
      {len: 60, sort:true},
      {len: 60, sort:false},
      {len: 30, sort:false}
    ];
    let data = null, meta = null, lastErr=null;
    for (const a of attempts) {
      const url = eiaURL({key, respondent, useLocal:false, length:a.len, sortDesc:a.sort});
      try{
        const json = await fetchWithRetry(url, {tries:[1,2], delay:1300});
        meta = {dateFormat: json.dateFormat, frequency: json.frequency, total: json.total};
        data = json.data;
        if (Array.isArray(data) && data.length) break;
      }catch(e){ lastErr=e; }
      await new Promise(r=>setTimeout(r, 1500));
    }
    if (!data || !data.length) {
      throw lastErr || new Error("No data returned from EIA after fallbacks.");
    }
    // data is newest-first if sort desc; normalize ascending time
    data.sort((a,b)=> (a.period>b.period?1:-1));
    // filter last 7*24 = 168 hours by timestamp
    // EIA returns UTC hour strings like "2025-08-14T21"
    const DateTime = window.luxon.DateTime;
    const cutoff = DateTime.utc().minus({hours:168});
    const rows = data.filter(d=>{
      const dt = DateTime.fromISO(String(d.period), {zone:'utc'});
      return dt >= cutoff;
    });
    // map to local tz for chart
    const points = rows.map(d=>{
      const dt = window.luxon.DateTime.fromISO(String(d.period), {zone:'utc'}).setZone(tz);
      return {x: dt.toISO(), y: Number(d.value)};
    });
    return {points, meta};
  }

  // --- Weather: Visual Crossing (10d hourly + daily mins/maxes) ---
  async function fetchWeather({lat,lon, tz, key}) {
    // VC "timeline" with include=hours,days and unitGroup=us
    const where = `${lat},${lon}`;
    const params = new URLSearchParams({
      key: key,
      unitGroup: "us",
      include: "hours,days",
      elements: "datetime,temp,tempmax,tempmin",
      tz: tz
    });
    const url = `https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/${where}?${params.toString()}`;
    const json = await fetchWithRetry(url, {tries:[1,2], delay:1200});
    // next 10 days hourly (including today)
    const DateTime = window.luxon.DateTime;
    const now = DateTime.now().setZone(tz);
    const tenOut = now.plus({days:10}).endOf('day');
    const hourly = (json.hours||json.days?.flatMap(d=>d.hours)||[]).map(h=>{
      const dt = DateTime.fromISO(h.datetime, {zone: tz});
      return {x: dt.toISO(), y: Number(h.temp)};
    }).filter(p=> DateTime.fromISO(p.x) <= tenOut);

    const daily = (json.days||[]).slice(0,10).map(d=>{
      return {
        date: d.datetime, // yyyy-MM-dd
        tmax: Number(d.tempmax),
        tmin: Number(d.tempmin)
      };
    });

    // Pick predicted peak-demand hour as hottest forecast hour in next 10 days
    const hottest = hourly.reduce((m,p)=> (m && m.y>=p.y)?m:p, null);

    return {hourly, daily, peakHour: hottest};
  }

  // --- Render one ISO card ---
  async function renderISO(resp) {
    const grid = document.getElementById("grid");
    const meta = ISO_META[resp];
    const id = `card-${resp}`;
    const card = makeCard(id, `${meta.name} (${resp})`, "7-day hourly demand (EIA) + temps; 10-day daily min/max + hourly temps");
    grid.appendChild(card);

    const eiaKey = (document.getElementById("eiaKey").value || "").trim();
    const wxKey  = (document.getElementById("wxKey").value  || "").trim();

    try{
      const [{points}, wx] = await Promise.all([
        eiaLatest7d(resp, meta.tz, eiaKey),
        fetchWeather({lat:meta.lat,lon:meta.lon,tz:meta.tz,key:wxKey})
      ]);

      const ctx = document.getElementById(id);
      const demand = points;                              // MW
      const tempsH = wx.hourly;                           // °F
      const DateTime = window.luxon.DateTime;

      // Build a quick min/max daily series for the last 7 days from hourly temps (fallback if VC daily missing)
      const tDaily = wx.daily;

      new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Demand (MW)',
              data: demand,
              yAxisID: 'y1',
              pointRadius: 0,
              borderWidth: 2,
            },
            {
              label: 'Temp (°F, hourly)',
              data: tempsH,
              yAxisID: 'y2',
              pointRadius: 0,
              borderDash: [4,4],
              borderWidth: 2,
            }
          ]
        },
        options: {
          responsive:true,
          interaction:{mode:'x', intersect:false},
          parsing:false,
          scales:{
            x: {type:'time', time:{unit:'hour'}, ticks:{maxRotation:0, autoSkip:true}},
            y1:{type:'linear', position:'left', title:{display:true,text:'MW'}, grid:{drawOnChartArea:true}},
            y2:{type:'linear', position:'right', title:{display:true,text:'°F'}, grid:{drawOnChartArea:false}}
          },
          plugins:{
            legend:{labels:{usePointStyle:true}},
            tooltip:{
              callbacks:{
                title:(items)=> items[0]?.parsed?.x ? DateTime.fromMillis(items[0].parsed.x).setZone(meta.tz).toFormat("ccc L/d HH:mm") : ''
              }
            }
          }
        }
      });

      // Append a small footer line with the predicted peak hour
      const footer = document.createElement('div');
      footer.className = 'err';
      footer.style.display = 'block';
      footer.style.borderTopColor = '#223357';
      footer.style.color = '#c9e8ff';
      footer.innerHTML = wx.peakHour
        ? `Outlook peak (by hottest hour): <span class="ok">${window.luxon.DateTime.fromISO(wx.peakHour.x).setZone(meta.tz).toFormat("ccc L/d HH:mm")}</span> at ~${Math.round(wx.peakHour.y)}°F`
        : 'Outlook peak hour not available.';
      card.appendChild(footer);

    }catch(e){
      console.error(e);
      showErr(id, `Failed: ${String(e.message||e).slice(0,240)}`);
    }
  }

  function assertLibs() {
    if (!(window.Chart && window.luxon && window.Chart.helpers)) {
      throw new Error("Chart.js failed to load");
    }
  }

  async function boot(){
    assertLibs();

    // if someone still has the old key in storage, show a hint
    if (localStorage.getItem("EIA_API_KEY") === EIA_OLD) {
      console.warn("Old EIA key found; updating to default/new.");
      localStorage.setItem("EIA_API_KEY", elEIA.value.trim());
    }

    const iso = (QS.get("iso") || elISO.value || "CISO");
    elISO.value = iso;
    document.getElementById("grid").innerHTML = "";
    await renderISO(iso);

    elISO.onchange = () => {
      history.replaceState(null, "", `${location.pathname}?iso=${elISO.value}`);
      location.reload();
    };
  }

  window.addEventListener("DOMContentLoaded", boot);
})();
</script>
</body>
</html>
