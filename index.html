<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy & Weather Forecast Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-field {
            flex: 1;
            min-width: 200px;
        }

        .input-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .input-field input, .input-field select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .input-field input:focus, .input-field select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 10px 5px;
        }

        .status-normal {
            background: #4CAF50;
            color: white;
        }

        .status-warning {
            background: #FF9800;
            color: white;
        }

        .status-emergency {
            background: #F44336;
            color: white;
        }

        .renewable-meter {
            background: #f0f0f0;
            border-radius: 20px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }

        .renewable-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            border-radius: 20px;
            transition: width 0.5s ease;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .alert-signup {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-top: 20px;
        }

        .alert-signup h3 {
            margin-bottom: 15px;
        }

        .alert-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: end;
        }

        .alert-form input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: none;
            border-radius: 8px;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-field {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Energy & Weather Forecast Dashboard</h1>
            <p>Advanced 30-Day Weather & Grid Load Predictions</p>
        </div>

        <div class="controls">
            <div class="input-group">
                <div class="input-field">
                    <label for="zipcode">ZIP Code</label>
                    <input type="text" id="zipcode" placeholder="Enter ZIP code" value="85718">
                </div>
                <div class="input-field">
                    <label for="iso">ISO Region</label>
                    <select id="iso">
                        <option value="NYISO">NYISO</option>
                        <option value="PJM">PJM</option>
                        <option value="CAISO">CAISO</option>
                        <option value="ERCOT">ERCOT</option>
                        <option value="ISONE">ISO-NE</option>
                        <option value="MISO">MISO</option>
                        <option value="SPP">SPP</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="manualUpdateDashboard()">Update Dashboard</button>
                <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
            </div>
        </div>

        <div class="refresh-indicator" id="refreshIndicator">
            Auto-refresh in: <span id="countdown">300</span>s
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h2>Current Conditions & Today's Peak Forecast - <span id="locationName">New York, NY</span></h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="currentTemp">--°F</h3>
                        <p>Current Temperature</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="todayPeak">--°F</h3>
                        <p>Today's Peak at <span id="todayPeakTime">--:--</span></p>
                    </div>
                    <div class="stat-card">
                        <h3 id="tomorrowPeak">--°F</h3>
                        <p>Tomorrow's Peak at <span id="tomorrowPeakTime">--:--</span></p>
                    </div>
                    <div class="stat-card">
                        <h3 id="currentLoad">-- MW</h3>
                        <p>Current Grid Load</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="todayGridPeak">-- MW</h3>
                        <p>Today's Grid Peak</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="tomorrowGridPeak">-- MW</h3>
                        <p>Tomorrow's Grid Peak</p>
                    </div>
                </div>
                
                <div class="status-indicator" id="gridStatus">Grid Status: Normal</div>
                
                <div>
                    <p>Renewable Energy Mix: <span id="renewablePercent">--</span>%</p>
                    <div class="renewable-meter">
                        <div class="renewable-fill" id="renewableFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>30-Day Weather & Temperature Forecast</h2>
                <div class="loading" id="weatherLoading">
                    <div class="spinner"></div>
                    Loading weather data...
                </div>
                <div class="chart-container">
                    <canvas id="weatherChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>30-Day Grid Load Forecast</h2>
                <div class="loading" id="loadLoading">
                    <div class="spinner"></div>
                    Loading grid data...
                </div>
                <div class="chart-container">
                    <canvas id="loadChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>Energy Generation Mix Forecast</h2>
                <div class="chart-container">
                    <canvas id="generationChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2>Forecast Accuracy Tracking (10-Day Lookback)</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="tempAccuracy">--%</h3>
                        <p>Temperature Accuracy</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="loadAccuracy">--%</h3>
                        <p>Load Forecast Accuracy</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="accuracyChart"></canvas>
                </div>
            </div>

            <div class="alert-signup">
                <h3>🚨 Peak Weather & ISO Alerts</h3>
                <p>Get notified of extreme weather and grid emergency conditions</p>
                <div class="alert-form">
                    <input type="email" placeholder="Email address" id="alertEmail">
                    <input type="tel" placeholder="Phone number (SMS)" id="alertPhone">
                    <button class="btn btn-secondary" onclick="signupAlerts()">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // ZIP code to ISO mapping based on geographic regions
        function getISOFromCoordinates(lat, lon) {
            // Determine ISO based on geographic boundaries
            if (lat >= 40.5 && lat <= 45.5 && lon >= -80 && lon <= -71) {
                return 'NYISO'; // New York
            } else if (lat >= 38.5 && lat <= 42.5 && lon >= -83 && lon <= -74) {
                return 'PJM'; // Mid-Atlantic
            } else if (lat >= 32.5 && lat <= 42 && lon >= -125 && lon <= -114) {
                return 'CAISO'; // California
            } else if (lat >= 25.8 && lat <= 36.5 && lon >= -106.5 && lon <= -93.5) {
                return 'ERCOT'; // Texas
            } else if (lat >= 41 && lat <= 47.5 && lon >= -73.5 && lon <= -66.5) {
                return 'ISONE'; // New England
            } else if (lat >= 37 && lat <= 49 && lon >= -104 && lon <= -82) {
                return 'MISO'; // Midwest
            } else if (lat >= 31 && lat <= 40 && lon >= -106 && lon <= -90) {
                return 'SPP'; // Southwest Power Pool
            } else {
                return 'PJM'; // Default fallback
            }
        }

        let weatherChart, loadChart, generationChart, accuracyChart;
        let refreshInterval;
        let countdownInterval;
        let currentData = {};
        let historicalData = JSON.parse(localStorage.getItem('weatherLoadHistory') || '[]');
        let currentLocation = { city: 'New York', state: 'NY', lat: 40.7128, lon: -74.0060 };
        
        // Auto-refresh countdown
        let countdown = 300;
        
        function startCountdown() {
            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                
                if (countdown <= 0) {
                    countdown = 300;
                    loadDashboard();
                }
            }, 1000);
        }

        // Simulated data generators (in real implementation, these would call actual APIs)
        function generateWeatherData(location) {
            const data = [];
            const today = new Date();
            
            // Base temperature varies by geographic location
            let baseTemp = 65; // Default
            if (location && location.lat && location.lon) {
                // Adjust base temperature by latitude (warmer in south, cooler in north)
                baseTemp = 85 - (location.lat - 25) * 0.8;
                // Adjust by longitude for continental effects
                if (location.lon < -100) baseTemp += 5; // West coast modifier
                if (location.lon > -80) baseTemp -= 3; // East coast modifier
                
                // Ensure reasonable temperature range
                baseTemp = Math.max(45, Math.min(85, baseTemp));
            }
            
            console.log(`Base temperature for location (${location?.lat}, ${location?.lon}): ${baseTemp}°F`);
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                // Simulate seasonal temperature patterns
                const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
                const seasonal = 20 * Math.sin((dayOfYear - 80) * 2 * Math.PI / 365);
                
                // Add daily variation
                const dailyVariation = (Math.random() - 0.5) * 12;
                
                const calculatedHigh = baseTemp + seasonal + dailyVariation;
                const calculatedLow = calculatedHigh - 15 - Math.random() * 8;
                
                // Ensure high is always higher than low
                const high = Math.round(Math.max(calculatedLow + 8, calculatedHigh));
                const low = Math.round(Math.min(high - 8, calculatedLow));
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    high: high,
                    low: low,
                    predicted: i > 7 // First 7 days are "forecast", rest are predictions
                });
            }
            
            console.log(`Generated weather data sample:`, data.slice(0, 3));
            return data;
        }

        function generateLoadData(weatherData, iso) {
            const data = [];
            
            // Base loads by ISO (in MW)
            const baseLoads = {
                'NYISO': 18000,
                'PJM': 85000,
                'CAISO': 45000,
                'ERCOT': 55000,
                'ISONE': 20000,
                'MISO': 75000,
                'SPP': 35000
            };
            
            const baseLoad = baseLoads[iso] || 20000;
            
            weatherData.forEach((weather, i) => {
                // Calculate load based on temperature (cooling and heating demand)
                const coolingLoad = Math.max(0, weather.high - 70) * 0.03; // 3% per degree above 70°F
                const heatingLoad = Math.max(0, 65 - weather.low) * 0.025; // 2.5% per degree below 65°F
                const tempFactor = 1 + coolingLoad + heatingLoad;
                
                const dailyLoad = Math.round(baseLoad * tempFactor * (0.9 + Math.random() * 0.2));
                
                // Peak load is typically 20-30% higher than average
                const peakLoad = Math.round(dailyLoad * (1.2 + Math.random() * 0.1));
                
                // Renewable percentage varies by region and weather
                let renewablePct;
                if (iso === 'CAISO') renewablePct = 45 + Math.random() * 25; // CA has high renewables
                else if (iso === 'ERCOT') renewablePct = 25 + Math.random() * 30; // TX has good wind
                else renewablePct = 20 + Math.random() * 25; // Other regions
                
                const fossilGeneration = dailyLoad * (100 - renewablePct) / 100;
                const solarGeneration = dailyLoad * (renewablePct * 0.6) / 100;
                const otherRenewables = dailyLoad * (renewablePct * 0.4) / 100;
                
                data.push({
                    date: weather.date,
                    load: dailyLoad,
                    peakLoad: peakLoad,
                    fossilGeneration: Math.round(fossilGeneration),
                    solarGeneration: Math.round(solarGeneration),
                    otherRenewables: Math.round(otherRenewables),
                    renewablePct: Math.round(renewablePct),
                    predicted: weather.predicted
                });
            });
            
            return data;
        }

        function updateCurrentConditions() {
            // Update location name
            document.getElementById('locationName').textContent = `${currentLocation.city}, ${currentLocation.state}`;
            
            // Get current ISO
            const iso = document.getElementById('iso').value;
            
            // Simulate current conditions based on location
            let baseTemp = 65;
            if (currentLocation.lat && currentLocation.lon) {
                baseTemp = 85 - (currentLocation.lat - 25) * 0.8;
                if (currentLocation.lon < -100) baseTemp += 5;
                if (currentLocation.lon > -80) baseTemp -= 3;
            }
            
            const currentTemp = Math.round(baseTemp + (Math.random() - 0.5) * 20);
            const todayPeak = Math.round(currentTemp + 8 + Math.random() * 12);
            const tomorrowPeak = Math.round(todayPeak + (Math.random() - 0.5) * 8);
            
            // Grid load based on ISO capacity
            const baseLoads = {
                'NYISO': 18000, 'PJM': 85000, 'CAISO': 45000, 'ERCOT': 55000,
                'ISONE': 20000, 'MISO': 75000, 'SPP': 35000
            };
            
            const baseLoad = baseLoads[iso] || 20000;
            const currentLoad = Math.round(baseLoad * (0.8 + Math.random() * 0.4));
            const todayGridPeak = Math.round(currentLoad * 1.25);
            const tomorrowGridPeak = Math.round(todayGridPeak * (0.95 + Math.random() * 0.1));
            
            const renewablePct = iso === 'CAISO' ? Math.round(45 + Math.random() * 25) : 
                                iso === 'ERCOT' ? Math.round(25 + Math.random() * 30) :
                                Math.round(20 + Math.random() * 25);
            
            document.getElementById('currentTemp').textContent = `${currentTemp}°F`;
            document.getElementById('todayPeak').textContent = `${todayPeak}°F`;
            document.getElementById('todayPeakTime').textContent = `${Math.round(12 + Math.random() * 4)}:00 PM`;
            document.getElementById('tomorrowPeak').textContent = `${tomorrowPeak}°F`;
            document.getElementById('tomorrowPeakTime').textContent = `${Math.round(12 + Math.random() * 4)}:00 PM`;
            document.getElementById('currentLoad').textContent = `${currentLoad.toLocaleString()} MW`;
            document.getElementById('todayGridPeak').textContent = `${todayGridPeak.toLocaleString()} MW`;
            document.getElementById('tomorrowGridPeak').textContent = `${tomorrowGridPeak.toLocaleString()} MW`;
            document.getElementById('renewablePercent').textContent = renewablePct;
            document.getElementById('renewableFill').style.width = `${renewablePct}%`;
            
            // Grid status simulation
            const statuses = ['Normal', 'Alert', 'Emergency'];
            const statusColors = ['status-normal', 'status-warning', 'status-emergency'];
            const randomStatus = currentLoad > baseLoad * 1.1 ? (Math.random() > 0.7 ? 2 : 1) : 0;
            const gridStatusEl = document.getElementById('gridStatus');
            gridStatusEl.textContent = `Grid Status: ${statuses[randomStatus]}`;
            gridStatusEl.className = `status-indicator ${statusColors[randomStatus]}`;
        }

        function createWeatherChart(data) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            
            if (weatherChart) {
                weatherChart.destroy();
            }
            
            weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'High Temperature',
                            data: data.map(d => d.high),
                            borderColor: '#E74C3C',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            pointBackgroundColor: '#E74C3C',
                            pointBorderColor: '#E74C3C',
                            pointRadius: 4
                        },
                        {
                            label: 'Low Temperature',
                            data: data.map(d => d.low),
                            borderColor: '#3498DB',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            pointBackgroundColor: '#3498DB',
                            pointBorderColor: '#3498DB',
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Temperature (°F)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            // Add predicted vs forecast styling (dashed lines for predictions)
            const highDataset = weatherChart.data.datasets[0];
            const lowDataset = weatherChart.data.datasets[1];
            
            // Create separate datasets for forecast vs predicted
            const forecastData = data.filter(d => !d.predicted);
            const predictedData = data.filter(d => d.predicted);
            
            if (predictedData.length > 0) {
                // Add dashed line datasets for predictions
                weatherChart.data.datasets.push({
                    label: 'High Temperature (Predicted)',
                    data: data.map(d => d.predicted ? d.high : null),
                    borderColor: '#E74C3C',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 3,
                    borderDash: [10, 5],
                    fill: false,
                    pointBackgroundColor: '#E74C3C',
                    pointBorderColor: '#E74C3C',
                    pointRadius: 3,
                    spanGaps: true
                });
                
                weatherChart.data.datasets.push({
                    label: 'Low Temperature (Predicted)',
                    data: data.map(d => d.predicted ? d.low : null),
                    borderColor: '#3498DB',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    borderDash: [10, 5],
                    fill: false,
                    pointBackgroundColor: '#3498DB',
                    pointBorderColor: '#3498DB',
                    pointRadius: 3,
                    spanGaps: true
                });
                
                // Modify original datasets to only show forecast data
                highDataset.data = data.map(d => !d.predicted ? d.high : null);
                lowDataset.data = data.map(d => !d.predicted ? d.low : null);
                highDataset.spanGaps = true;
                lowDataset.spanGaps = true;
            }
            
            weatherChart.update();
        }low),
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Temperature (°F)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            // Add predicted vs forecast styling
            const datasets = weatherChart.data.datasets;
            datasets.forEach(dataset => {
                dataset.borderDash = data.map(d => d.predicted ? [5, 5] : []);
            });
            weatherChart.update();
        }

        function createLoadChart(data) {
            const ctx = document.getElementById('loadChart').getContext('2d');
            
            if (loadChart) {
                loadChart.destroy();
            }
            
            // Separate forecast and predicted data
            const forecastData = data.filter(d => !d.predicted);
            const predictedData = data.filter(d => d.predicted);
            
            loadChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'Load Forecast (ISO)',
                            data: data.map(d => !d.predicted ? d.load : null),
                            borderColor: '#2C3E50',
                            backgroundColor: 'rgba(44, 62, 80, 0.1)',
                            borderWidth: 4,
                            fill: false,
                            pointBackgroundColor: '#2C3E50',
                            pointRadius: 4,
                            spanGaps: true
                        },
                        {
                            label: 'Load Predicted (Temperature-based)',
                            data: data.map(d => d.predicted ? d.load : null),
                            borderColor: '#2C3E50',
                            backgroundColor: 'rgba(44, 62, 80, 0.1)',
                            borderWidth: 4,
                            borderDash: [15, 8],
                            fill: false,
                            pointBackgroundColor: '#2C3E50',
                            pointRadius: 3,
                            spanGaps: true
                        },
                        {
                            label: 'Fossil Generation',
                            data: data.map(d => d.fossilGeneration),
                            borderColor: '#8B4513',
                            backgroundColor: 'rgba(139, 69, 19, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 2
                        },
                        {
                            label: 'Solar Generation',
                            data: data.map(d => d.solarGeneration),
                            borderColor: '#F39C12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 2
                        },
                        {
                            label: 'Other Renewables',
                            data: data.map(d => d.otherRenewables),
                            borderColor: '#27AE60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterBody: function(tooltipItems) {
                                    const dataIndex = tooltipItems[0].dataIndex;
                                    const dataPoint = data[dataIndex];
                                    return [
                                        `Peak Load: ${dataPoint.peakLoad.toLocaleString()} MW`,
                                        `Renewable %: ${dataPoint.renewablePct}%`,
                                        `Source: ${dataPoint.predicted ? 'Temperature Prediction' : 'ISO Forecast'}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Megawatts (MW)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function createGenerationChart(data) {
            const ctx = document.getElementById('generationChart').getContext('2d');
            
            if (generationChart) {
                generationChart.destroy();
            }
            
            generationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'Renewable Percentage',
                            data: data.map(d => d.renewablePct),
                            borderColor: '#27AE60',
                            backgroundColor: 'rgba(39, 174, 96, 0.2)',
                            borderWidth: 3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Renewable Percentage (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        function createAccuracyChart() {
            const ctx = document.getElementById('accuracyChart').getContext('2d');
            
            if (accuracyChart) {
                accuracyChart.destroy();
            }
            
            // Generate mock accuracy data
            const accuracyData = [];
            for (let i = 9; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                accuracyData.push({
                    date: date.toLocaleDateString(),
                    tempAccuracy: Math.round(75 + Math.random() * 20),
                    loadAccuracy: Math.round(70 + Math.random() * 25)
                });
            }
            
            accuracyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: accuracyData.map(d => d.date),
                    datasets: [
                        {
                            label: 'Temperature Accuracy (%)',
                            data: accuracyData.map(d => d.tempAccuracy),
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: '#E74C3C',
                            borderWidth: 1
                        },
                        {
                            label: 'Load Accuracy (%)',
                            data: accuracyData.map(d => d.loadAccuracy),
                            backgroundColor: 'rgba(44, 62, 80, 0.7)',
                            borderColor: '#2C3E50',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Accuracy (%)'
                            }
                        }
                    }
                }
            });
            
            // Update accuracy stats
            const avgTempAccuracy = Math.round(accuracyData.reduce((sum, d) => sum + d.tempAccuracy, 0) / accuracyData.length);
            const avgLoadAccuracy = Math.round(accuracyData.reduce((sum, d) => sum + d.loadAccuracy, 0) / accuracyData.length);
            
            document.getElementById('tempAccuracy').textContent = `${avgTempAccuracy}%`;
            document.getElementById('loadAccuracy').textContent = `${avgLoadAccuracy}%`;
        }

        function loadDashboard() {
            console.log('Loading dashboard...');
            
            // Show loading indicators
            document.getElementById('weatherLoading').style.display = 'block';
            document.getElementById('loadLoading').style.display = 'block';
            
            // Reset countdown
            countdown = 300;
            
            const zipcode = document.getElementById('zipcode').value;
            const iso = document.getElementById('iso').value;
            
            console.log(`Loading dashboard for ZIP: ${zipcode}, ISO: ${iso}, Location:`, currentLocation);
            
            setTimeout(() => {
                try {
                    // Generate data based on current location and ISO
                    const weatherData = generateWeatherData(currentLocation);
                    const loadData = generateLoadData(weatherData, iso);
                    
                    console.log('Generated weather data:', weatherData.slice(0, 3));
                    console.log('Generated load data:', loadData.slice(0, 3));
                    
                    // Store current data
                    currentData = { weatherData, loadData, timestamp: new Date() };
                    
                    // Update charts
                    createWeatherChart(weatherData);
                    createLoadChart(loadData);
                    createGenerationChart(loadData);
                    createAccuracyChart();
                    
                    // Update current conditions
                    updateCurrentConditions();
                    
                    // Hide loading indicators
                    document.getElementById('weatherLoading').style.display = 'none';
                    document.getElementById('loadLoading').style.display = 'none';
                    
                    // Store historical data
                    storeHistoricalData();
                    
                    console.log('Dashboard loaded successfully');
                    
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                    
                    // Hide loading indicators even on error
                    document.getElementById('weatherLoading').style.display = 'none';
                    document.getElementById('loadLoading').style.display = 'none';
                    
                    // Show error message
                    alert('Error loading dashboard data. Please try again.');
                }
                
            }, 1000); // Reduced loading time for better UX
        }

        // Function to update ISO and location when zipcode changes
        async function updateLocationFromZipcode() {
            const zipcode = document.getElementById('zipcode').value;
            
            if (zipcode.length === 5) {
                try {
                    // Fetch location data from public API
                    const location = await fetchLocationData(zipcode);
                    currentLocation = location;
                    
                    // Determine ISO from coordinates
                    const iso = getISOFromCoordinates(location.lat, location.lon);
                    document.getElementById('iso').value = iso;
                    
                    // Update location display immediately
                    document.getElementById('locationName').textContent = `${location.city}, ${location.state}`;
                    
                    // Auto-load dashboard with new data
                    loadDashboard();
                } catch (error) {
                    console.error('Error fetching location data:', error);
                    // Keep current location as fallback
                }
            }
        }

        function storeHistoricalData() {
            const entry = {
                timestamp: new Date().toISOString(),
                zipcode: document.getElementById('zipcode').value,
                iso: document.getElementById('iso').value,
                data: currentData
            };
            
            historicalData.push(entry);
            
            // Keep only last 100 entries
            if (historicalData.length > 100) {
                historicalData = historicalData.slice(-100);
            }
            
            localStorage.setItem('weatherLoadHistory', JSON.stringify(historicalData));
        }

        function exportData() {
            if (!currentData.weatherData) {
                alert('Please load data first');
                return;
            }
            
            const exportData = {
                timestamp: new Date().toISOString(),
                zipcode: document.getElementById('zipcode').value,
                iso: document.getElementById('iso').value,
                weatherForecast: currentData.weatherData,
                loadForecast: currentData.loadData,
                historicalAccuracy: historicalData
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `weather-load-forecast-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function signupAlerts() {
            const email = document.getElementById('alertEmail').value;
            const phone = document.getElementById('alertPhone').value;
            
            if (!email && !phone) {
                alert('Please enter an email or phone number');
                return;
            }
            
            // In a real implementation, this would send the data to a backend service
            alert(`Alert signup successful! You'll receive notifications at:\n${email ? 'Email: ' + email + '\n' : ''}${phone ? 'SMS: ' + phone : ''}`);
            
            // Clear form
            document.getElementById('alertEmail').value = '';
            document.getElementById('alertPhone').value = '';
        }

        // Fetch location data from public APIs
        async function fetchLocationData(zipcode) {
            try {
                // Use Zippopotam.us API (free, no API key required)
                const response = await fetch(`https://api.zippopotam.us/us/${zipcode}`);
                if (!response.ok) throw new Error('ZIP code not found');
                
                const data = await response.json();
                const place = data.places[0];
                
                return {
                    city: place['place name'],
                    state: place['state abbreviation'],
                    lat: parseFloat(place.latitude),
                    lon: parseFloat(place.longitude)
                };
            } catch (error) {
                console.error('Location API error:', error);
                // Fallback: try alternative API
                try {
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${zipcode}&count=1&language=en&format=json`);
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const result = data.results[0];
                        return {
                            city: result.name,
                            state: result.admin1 || 'Unknown',
                            lat: result.latitude,
                            lon: result.longitude
                        };
                    }
                } catch (secondError) {
                    console.error('Secondary API error:', secondError);
                }
                
                // Final fallback to default NYC
                return {
                    city: 'New York',
                    state: 'NY',
                    lat: 40.7128,
                    lon: -74.0060
                };
            }
        }

        // Enhanced prediction algorithms
        function predictTemperatureFromHistorical(date) {
            // In real implementation, this would analyze 5 years of historical data
            // for the same calendar day and calculate averages
            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
            const seasonal = 30 * Math.sin((dayOfYear - 80) * 2 * Math.PI / 365);
            
            // Simulate historical average with some variance
            const historicalHigh = 70 + seasonal + (Math.random() - 0.5) * 5;
            const historicalLow = historicalHigh - 20 + (Math.random() - 0.5) * 5;
            
            return {
                high: Math.round(historicalHigh),
                low: Math.round(historicalLow)
            };
        }

        function predictLoadFromTemperature(temperature, iso) {
            // In real implementation, this would use regression analysis
            // of 5 years of temperature vs load data for the specific ISO
            
            // Cooling degree days (CDD) and heating degree days (HDD)
            const coolingBase = 65;
            const heatingBase = 65;
            
            let loadMultiplier = 1;
            
            if (temperature > coolingBase) {
                // Air conditioning load increases exponentially with heat
                const cdd = temperature - coolingBase;
                loadMultiplier += cdd * 0.03; // 3% increase per degree above 65°F
            } else if (temperature < heatingBase) {
                // Heating load increases with cold
                const hdd = heatingBase - temperature;
                loadMultiplier += hdd * 0.025; // 2.5% increase per degree below 65°F
            }
            
            // Base load varies by ISO
            const baseLoads = {
                'NYISO': 18000,
                'PJM': 85000,
                'CAISO': 45000,
                'ERCOT': 55000,
                'ISONE': 20000,
                'MISO': 75000,
                'SPP': 35000
            };
            
            const baseLoad = baseLoads[iso] || 20000;
            return Math.round(baseLoad * loadMultiplier);
        }

        // Enhanced chart interactions with tooltips and crosshair
        function addChartInteractions(chart) {
            const canvas = chart.canvas;
            const tooltip = document.getElementById('tooltip');
            
            canvas.addEventListener('mousemove', (e) => {
                const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                
                if (points.length) {
                    const firstPoint = points[0];
                    const datasetIndex = firstPoint.datasetIndex;
                    const index = firstPoint.index;
                    const dataset = chart.data.datasets[datasetIndex];
                    const value = dataset.data[index];
                    const label = chart.data.labels[index];
                    
                    tooltip.style.display = 'block';
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY - 10 + 'px';
                    tooltip.innerHTML = `
                        <strong>${dataset.label}</strong><br>
                        Date: ${label}<br>
                        Value: ${value}${dataset.label.includes('Temperature') ? '°F' : dataset.label.includes('Percentage') ? '%' : ' MW'}
                    `;
                } else {
                    tooltip.style.display = 'none';
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }

        // Grid status monitoring
        function updateGridStatus(loadData) {
            // Simulate grid status based on load levels and renewable mix
            const currentLoad = loadData[0]?.load || 0;
            const renewablePct = loadData[0]?.renewablePct || 0;
            
            let status = 'Normal';
            let statusClass = 'status-normal';
            
            if (currentLoad > 18000 && renewablePct < 30) {
                status = 'Alert - High Load, Low Renewables';
                statusClass = 'status-warning';
            } else if (currentLoad > 20000) {
                status = 'Emergency - Extreme Load';
                statusClass = 'status-emergency';
            } else if (renewablePct > 70) {
                status = 'Optimal - High Renewables';
                statusClass = 'status-normal';
            }
            
            const gridStatusEl = document.getElementById('gridStatus');
            gridStatusEl.textContent = `Grid Status: ${status}`;
            gridStatusEl.className = `status-indicator ${statusClass}`;
        }

        // Renewable energy cleanliness indicator
        function updateRenewableIndicator(renewablePct) {
            const renewableFill = document.getElementById('renewableFill');
            const renewablePercent = document.getElementById('renewablePercent');
            
            renewableFill.style.width = `${renewablePct}%`;
            renewablePercent.textContent = renewablePct;
            
            // Update color based on cleanliness
            if (renewablePct >= 70) {
                renewableFill.style.background = 'linear-gradient(90deg, #27AE60 0%, #2ECC71 100%)';
            } else if (renewablePct >= 40) {
                renewableFill.style.background = 'linear-gradient(90deg, #F39C12 0%, #E67E22 100%)';
            } else {
                renewableFill.style.background = 'linear-gradient(90deg, #E74C3C 0%, #C0392B 100%)';
            }
        }

        // Manual dashboard update function
        function manualUpdateDashboard() {
            console.log('Manual dashboard update triggered');
            const zipcode = document.getElementById('zipcode').value;
            
            if (zipcode.length === 5 && /^\d{5}$/.test(zipcode)) {
                updateLocationFromZipcode();
            } else {
                loadDashboard();
            }
        }

        // Initialize dashboard
        function initializeDashboard() {
            loadDashboard();
            startCountdown();
            
            // Set up auto-refresh
            refreshInterval = setInterval(() => {
                loadDashboard();
            }, 300000); // 5 minutes
            
            // Add event listeners
            document.getElementById('zipcode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    updateLocationFromZipcode();
                }
            });
            
            document.getElementById('zipcode').addEventListener('blur', updateLocationFromZipcode);
            
            document.getElementById('iso').addEventListener('change', loadDashboard);            document.getElementById('zipcode').addEventListener('input', (e) => {
                const zipcode = e.target.value;
                if (zipcode.length === 5 && /^\d{5}$/.test(zipcode)) {
                    updateLocationFromZipcode();
                }
            });
            
            document.getElementById('iso').addEventListener('change', loadDashboard);
        }

        // Enhanced data export with more formats
        function exportDataAdvanced(format = 'json') {
            if (!currentData.weatherData) {
                alert('Please load data first');
                return;
            }
            
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    zipcode: document.getElementById('zipcode').value,
                    iso: document.getElementById('iso').value,
                    dataSource: 'Weather.gov & EIA.gov'
                },
                weatherForecast: currentData.weatherData,
                loadForecast: currentData.loadData,
                historicalAccuracy: historicalData,
                summary: {
                    avgTemperatureHigh: Math.round(currentData.weatherData.reduce((sum, d) => sum + d.high, 0) / currentData.weatherData.length),
                    avgTemperatureLow: Math.round(currentData.weatherData.reduce((sum, d) => sum + d.low, 0) / currentData.weatherData.length),
                    avgLoad: Math.round(currentData.loadData.reduce((sum, d) => sum + d.load, 0) / currentData.loadData.length),
                    avgRenewablePct: Math.round(currentData.loadData.reduce((sum, d) => sum + d.renewablePct, 0) / currentData.loadData.length)
                }
            };
            
            let blob, filename;
            
            if (format === 'csv') {
                // Convert to CSV format
                const csvData = currentData.weatherData.map((weather, i) => {
                    const load = currentData.loadData[i];
                    return {
                        Date: weather.date,
                        HighTemp: weather.high,
                        LowTemp: weather.low,
                        Load_MW: load.load,
                        FossilGeneration_MW: load.fossilGeneration,
                        SolarGeneration_MW: load.solarGeneration,
                        OtherRenewables_MW: load.otherRenewables,
                        RenewablePct: load.renewablePct,
                        IsPredicted: weather.predicted
                    };
                });
                
                const csvContent = [
                    Object.keys(csvData[0]).join(','),
                    ...csvData.map(row => Object.values(row).join(','))
                ].join('\n');
                
                blob = new Blob([csvContent], { type: 'text/csv' });
                filename = `weather-load-forecast-${new Date().toISOString().split('T')[0]}.csv`;
            } else {
                blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                filename = `weather-load-forecast-${new Date().toISOString().split('T')[0]}.json`;
            }
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing dashboard...');
            initializeDashboard();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) clearInterval(refreshInterval);
            if (countdownInterval) clearInterval(countdownInterval);
        });

        // Make functions globally accessible
        window.manualUpdateDashboard = manualUpdateDashboard;
        window.exportData = exportData;
        window.exportDataAdvanced = exportDataAdvanced;
        window.signupAlerts = signupAlerts;

    </script>
</body>
</html>
